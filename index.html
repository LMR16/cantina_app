<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Cantina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-button.active { background-color: #f97316; color: white; }
        .nav-button { transition: all 0.2s ease-in-out; text-align: left; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-header-icon { transition: transform 0.3s ease-out; }
        .open .accordion-header-icon { transform: rotate(90deg); }
        .modal-overlay { transition: opacity 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div class="md:grid md:grid-cols-[280px_1fr] min-h-screen">
        <aside class="bg-white p-6 flex flex-col border-r border-stone-200">
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-stone-900">Painel da Cantina</h1>
                <p class="text-stone-600 text-sm">Gerencie seu negócio</p>
            </header>
            <nav class="flex flex-col gap-3">
                <button data-view="painel" class="nav-button active w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Painel Diário</button>
                <button data-view="registrar" class="nav-button w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Registrar Venda</button>
                <button data-view="produtos" class="nav-button w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Produtos</button>
                <button data-view="historico" class="nav-button w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Histórico</button>
            </nav>
        </aside>
        <div class="p-4 md:p-8 overflow-y-auto">
            <main>
                <!-- O resto do seu HTML permanece exatamente igual -->
                <!-- ... -->
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // =================================================================
            // MUDANÇA IMPORTANTE: A URL agora aponta para a nossa função Netlify
            // =================================================================
            const API_ENDPOINT = '/.netlify/functions/sheets';

            let DB = {
                produtos: [],
                categorias: [],
                imagens: [],
                vendas: [],
                itens_venda: []
            };

            async function fetchData() {
                showLoading(true);
                try {
                    const sheetsToFetch = ['produtos', 'categorias', 'imagens', 'vendas', 'itens_venda'];
                    
                    // Helper para processar a resposta
                    const processResponse = async (response, sheetName) => {
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`Falha ao buscar a aba '${sheetName}'. Status: ${response.status}. Mensagem: ${errorData.message || 'Erro desconhecido'}`);
                        }
                        return response.json();
                    };

                    // Busca os dados sequencialmente para ser mais fiável
                    DB.produtos = await fetch(`${API_ENDPOINT}?sheet=produtos`).then(res => processResponse(res, 'produtos'));
                    DB.categorias = await fetch(`${API_ENDPOINT}?sheet=categorias`).then(res => processResponse(res, 'categorias'));
                    DB.imagens = await fetch(`${API_ENDPOINT}?sheet=imagens`).then(res => processResponse(res, 'imagens'));
                    DB.vendas = await fetch(`${API_ENDPOINT}?sheet=vendas`).then(res => processResponse(res, 'vendas'));
                    DB.itens_venda = await fetch(`${API_ENDPOINT}?sheet=itens_venda`).then(res => processResponse(res, 'itens_venda'));
                    
                    renderCurrentView();

                } catch (error) {
                    alert(`Ocorreu um erro crítico ao carregar os dados:\n\n${error.message}`);
                    console.error("=== ERRO DETALHADO EM fetchData ===", error);
                } finally {
                    showLoading(false);
                }
            }
            
            function showLoading(isLoading) {
                let overlay = document.getElementById('loading-overlay');
                if (isLoading) {
                    if (!overlay) {
                        document.body.insertAdjacentHTML('beforeend', '<div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50"><p class="text-lg font-semibold">Carregando dados...</p></div>');
                    }
                } else {
                    if (overlay) overlay.remove();
                }
            }
            
            // O resto do seu JavaScript (renderização, manipulação do carrinho, etc.)
            // permanece exatamente igual. Não precisa de alterar mais nada.
            // ...

            // Inicia o carregamento dos dados
            fetchData();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Cantina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 
        Chosen Palette: Warm Neutrals (bg-stone-50, bg-white, text-stone-800, accent text-orange-600)
        
        Application Structure Plan: A tab-based Single Page Application (SPA) with four main sections: 
        1. 'Painel Diário': A dashboard for at-a-glance daily metrics. This is the landing page for quick insights.
        2. 'Registrar Venda': A task-oriented "shopping cart" interface for rapid order entry, which was a key user requirement for practicality.
        3. 'Produtos': A catalog management view with tabs to filter between "Active" and "Inactive" products, simplifying inventory management.
        4. 'Histórico': An exploratory, accordion-style drill-down report view, allowing users to navigate from yearly summaries down to individual sales.
        This structure was chosen to separate distinct user tasks (viewing, creating, managing, analyzing) into clear, focused sections, improving usability.
    -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn.active {
            background-color: #ea580c; /* orange-600 */
            color: white;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-item.open .accordion-content {
            max-height: 1000px; /* Adjust as needed */
            transition: max-height 0.5s ease-in;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ea580c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-stone-900">Painel da Cantina</h1>
            <p class="text-stone-600 mt-1">Gerencie suas vendas e produtos com facilidade.</p>
        </header>

        <!-- Abas de Navegação -->
        <div class="mb-6 border-b border-stone-200">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button onclick="showTab('painel-diario')" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-stone-600 hover:bg-stone-200 rounded-t-lg">Painel Diário</button>
                <button onclick="showTab('registrar-venda')" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-stone-600 hover:bg-stone-200 rounded-t-lg">Registrar Venda</button>
                <button onclick="showTab('produtos')" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-stone-600 hover:bg-stone-200 rounded-t-lg">Produtos</button>
                <button onclick="showTab('historico')" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 border-transparent font-medium text-sm text-stone-600 hover:bg-stone-200 rounded-t-lg">Histórico</button>
            </nav>
        </div>

        <!-- Conteúdo das Abas -->
        <main>
            <!-- Aba: Painel Diário -->
            <div id="painel-diario" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                        <h3 class="text-sm font-medium text-stone-500">Vendas (Hoje)</h3>
                        <p id="metric-vendas-hoje" class="mt-1 text-3xl font-semibold text-orange-600">--</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                        <h3 class="text-sm font-medium text-stone-500">Receita (Hoje)</h3>
                        <p id="metric-receita-hoje" class="mt-1 text-3xl font-semibold text-orange-600">R$ --</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                        <h3 class="text-sm font-medium text-stone-500">Ticket Médio (Hoje)</h3>
                        <p id="metric-ticket-medio" class="mt-1 text-3xl font-semibold text-orange-600">R$ --</p>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                        <h3 class="text-sm font-medium text-stone-500">Produto Mais Vendido (Hoje)</h3>
                        <p id="metric-produto-top" class="mt-1 text-2xl font-semibold text-orange-600">--</p>
                    </div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                    <h3 class="text-lg font-medium text-stone-800">Últimas 5 Vendas</h3>
                    <div id="ultimas-vendas-container" class="mt-4 space-y-3">
                        <!-- Vendas serão inseridas aqui -->
                        <p class="text-stone-500">Carregando vendas...</p>
                    </div>
                </div>
            </div>

            <!-- Aba: Registrar Venda -->
            <div id="registrar-venda" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Coluna de Produtos -->
                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                            <h3 class="text-lg font-medium text-stone-800">Selecione os Produtos</h3>
                            <div class="my-4">
                                <input type="text" id="search-product-input" placeholder="Buscar produto por nome..." class="w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                            </div>
                            <div id="product-list-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4 max-h-[60vh] overflow-y-auto p-2">
                                <!-- Produtos para venda serão carregados aqui -->
                            </div>
                        </div>
                    </div>

                    <!-- Coluna do Carrinho -->
                    <div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 sticky top-8">
                            <h3 class="text-lg font-medium text-stone-800">Carrinho</h3>
                            <div class="mt-4 space-y-3" id="cart-items-container">
                                <!-- Itens do carrinho aqui -->
                                <p class="text-stone-500">O carrinho está vazio.</p>
                            </div>
                            <div class="mt-6 border-t pt-4">
                                <div class="flex justify-between items-center text-xl font-bold">
                                    <span>Total:</span>
                                    <span id="cart-total">R$ 0,00</span>
                                </div>
                                <div class="mt-4 flex">
                                    <div class="w-1/2 pr-2">
                                        <label for="metodo-pagamento" class="block text-sm font-medium text-stone-700">Pagamento</label>
                                        <select id="metodo-pagamento" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                            <option>PIX</option>
                                            <option>Cartão</option>
                                            <option>Dinheiro</option>
                                        </select>
                                    </div>
                                    <div class="w-1/2 pl-2">
                                        <label for="turno-venda" class="block text-sm font-medium text-stone-700">Turno</label>
                                        <select id="turno-venda" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                            <option>Manhã</option>
                                            <option>Noite</option>
                                        </select>
                                    </div>
                                </div>
                                <button id="finalize-sale-btn" class="mt-6 w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 disabled:bg-orange-300 transition-colors">
                                    Finalizar Venda
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba: Produtos -->
            <div id="produtos" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-stone-800">Gerenciar Produtos</h2>
                        <button id="add-product-btn" class="bg-orange-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-orange-700 transition-colors">Adicionar Produto</button>
                    </div>
                    <div id="product-management-container">
                        <!-- Tabela de produtos será inserida aqui -->
                    </div>
                </div>
            </div>

            <!-- Aba: Histórico -->
            <div id="historico" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                    <h2 class="text-xl font-bold text-stone-800 mb-4">Histórico de Vendas</h2>
                    <div id="sales-history-container" class="space-y-2">
                        <!-- Histórico em formato accordion será inserido aqui -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Adicionar/Editar Produto -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Adicionar Novo Produto</h2>
            <form id="product-form">
                <input type="hidden" id="produto-id">
                <div class="space-y-4">
                    <div>
                        <label for="produto-nome" class="block text-sm font-medium text-stone-700">Nome do Produto</label>
                        <input type="text" id="produto-nome" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    </div>
                    <div>
                        <label for="produto-categoria" class="block text-sm font-medium text-stone-700">Categoria</label>
                        <select id="produto-categoria" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                            <!-- Categorias carregadas aqui -->
                        </select>
                    </div>
                    <div>
                        <label for="produto-preco" class="block text-sm font-medium text-stone-700">Preço (R$)</label>
                        <input type="number" id="produto-preco" step="0.01" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    </div>
                    <div>
                        <label for="produto-imagem" class="block text-sm font-medium text-stone-700">URL da Imagem</label>
                        <input type="text" id="produto-imagem" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="cancel-product-btn" class="bg-stone-200 text-stone-800 py-2 px-4 rounded-lg hover:bg-stone-300">Cancelar</button>
                    <button type="submit" class="bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700">Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 id="confirmation-title" class="text-lg font-bold mb-4">Confirmar Ação</h2>
            <p id="confirmation-message" class="text-stone-600 mb-6">Você tem certeza?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-confirmation-btn" class="bg-stone-200 text-stone-800 py-2 px-4 rounded-lg hover:bg-stone-300">Cancelar</button>
                <button id="confirm-action-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 ease-out z-50">
        <p id="toast-message"></p>
    </div>


    <script>
        // =================================================================
        // CONFIGURAÇÃO
        // =================================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw9WwGz_4w3sS-A7iM-gG6y4K4J7m7r4N3r5X2p0w0z1B1c2k3L8H7J6g/exec";

        // =================================================================
        // ESTADO DA APLICAÇÃO
        // =================================================================
        let allProducts = [];
        let allCategories = [];
        let allSales = [];
        let allSaleItems = [];
        let cart = [];

        // =================================================================
        // FUNÇÕES DE INICIALIZAÇÃO E CARREGAMENTO DE DADOS
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            showTab('painel-diario');
            fetchAllData();
            setupEventListeners();
        });

        async function fetchAllData() {
            try {
                showGlobalLoader(true);
                const [products, categories, sales, saleItems] = await Promise.all([
                    fetchData('produtos'),
                    fetchData('categorias'),
                    fetchData('vendas'),
                    fetchData('itens_venda')
                ]);
                
                allProducts = products;
                allCategories = categories;
                allSales = sales;
                allSaleItems = saleItems;

                // Após carregar todos os dados, atualiza a UI
                updateDashboard();
                populateProductsForSale();
                populateCategoryFilter();
                
            } catch (error) {
                console.error("Erro ao carregar dados iniciais:", error);
                showToast("Falha ao carregar dados. Tente recarregar a página.", "error");
            } finally {
                showGlobalLoader(false);
            }
        }

        async function fetchData(sheetName) {
            try {
                const response = await fetch(`${SCRIPT_URL}?sheet=${sheetName}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if(data.status === 'error') {
                    throw new Error(`API Error: ${data.message}`);
                }
                return data;
            } catch (error) {
                console.error(`Erro ao buscar dados da aba '${sheetName}':`, error);
                throw error; // Re-throw para ser pego pelo Promise.all
            }
        }
        
        // =================================================================
        // LÓGICA DAS ABAS E UI
        // =================================================================
        function showTab(tabName) {
            // Esconde todos os conteúdos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            // Desativa todos os botões
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-orange-600', 'text-white');
                btn.classList.add('text-stone-600', 'hover:bg-stone-200');
            });

            // Mostra o conteúdo da aba selecionada
            document.getElementById(tabName).classList.remove('hidden');
            // Ativa o botão da aba selecionada
            const activeButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            activeButton.classList.add('active', 'bg-orange-600', 'text-white');
            activeButton.classList.remove('text-stone-600', 'hover:bg-stone-200');

            // Ações específicas para cada aba
            if (tabName === 'painel-diario') {
                updateDashboard();
            }
            if (tabName === 'produtos') {
                loadProductsForManagement();
            }
            if (tabName === 'historico') {
                loadSalesHistory();
            }
            // =============================================================
            // NOVA LÓGICA: Define o turno automaticamente
            // =============================================================
            if (tabName === 'registrar-venda') {
                const turnoSelect = document.getElementById('turno-venda');
                const currentHour = new Date().getHours();
                // Se a hora for antes das 14h (0-13), é "Manhã"
                if (currentHour < 14) {
                    turnoSelect.value = 'Manhã';
                } else {
                    turnoSelect.value = 'Noite';
                }
            }
        }
        
        function setupEventListeners() {
            // Pesquisa de produtos na tela de venda
            document.getElementById('search-product-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredProducts = allProducts.filter(p => p.Status === 'Ativo' && p.Nome_Produto.toLowerCase().includes(searchTerm));
                populateProductsForSale(filteredProducts);
            });
            
            // Finalizar venda
            document.getElementById('finalize-sale-btn').addEventListener('click', handleFinalizeSale);
            
            // Abrir modal para adicionar produto
            document.getElementById('add-product-btn').addEventListener('click', () => showProductModal());

            // Fechar modal
            document.getElementById('cancel-product-btn').addEventListener('click', () => hideProductModal());

            // Submeter formulário do produto (criar/editar)
            document.getElementById('product-form').addEventListener('submit', handleProductFormSubmit);
            
            // Botões do modal de confirmação
            document.getElementById('cancel-confirmation-btn').addEventListener('click', hideConfirmationModal);
        }

        // =================================================================
        // PAINEL DIÁRIO
        // =================================================================
        function updateDashboard() {
            const todayStr = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            
            const salesToday = allSales.filter(sale => sale.Data_Venda.startsWith(todayStr));
            const saleItemsToday = allSaleItems.filter(item => {
                const sale = allSales.find(s => s.Venda_ID === item.Venda_Ref);
                return sale && sale.Data_Venda.startsWith(todayStr);
            });

            // Métrica 1: Vendas Hoje
            const totalSalesToday = salesToday.length;
            document.getElementById('metric-vendas-hoje').textContent = totalSalesToday;

            // Métrica 2: Receita Hoje
            const totalRevenueToday = salesToday.reduce((sum, sale) => sum + parseFloat(sale.Valor_Total), 0);
            document.getElementById('metric-receita-hoje').textContent = `R$ ${totalRevenueToday.toFixed(2).replace('.', ',')}`;

            // Métrica 3: Ticket Médio
            const averageTicket = totalSalesToday > 0 ? (totalRevenueToday / totalSalesToday) : 0;
            document.getElementById('metric-ticket-medio').textContent = `R$ ${averageTicket.toFixed(2).replace('.', ',')}`;

            // Métrica 4: Produto mais vendido
            let topProduct = '--';
            if (saleItemsToday.length > 0) {
                const productCounts = saleItemsToday.reduce((acc, item) => {
                    acc[item.Produto_Nome] = (acc[item.Produto_Nome] || 0) + item.Quantidade;
                    return acc;
                }, {});
                topProduct = Object.keys(productCounts).reduce((a, b) => productCounts[a] > productCounts[b] ? a : b, '');
            }
            document.getElementById('metric-produto-top').textContent = topProduct;
            
            // Últimas 5 vendas
            const last5Sales = salesToday.slice(-5).reverse();
            const container = document.getElementById('ultimas-vendas-container');
            container.innerHTML = '';
            if (last5Sales.length === 0) {
                container.innerHTML = '<p class="text-stone-500">Nenhuma venda registrada hoje.</p>';
                return;
            }
            last5Sales.forEach(sale => {
                const saleEl = document.createElement('div');
                saleEl.className = 'flex justify-between items-center bg-stone-50 p-3 rounded-lg';
                saleEl.innerHTML = `
                    <div>
                        <p class="font-medium">Venda #${sale.Venda_ID}</p>
                        <p class="text-sm text-stone-500">${new Date(sale.Data_Venda).toLocaleTimeString('pt-BR')} - ${sale.Metodo_Pagamento}</p>
                    </div>
                    <div class="font-semibold text-lg">R$ ${parseFloat(sale.Valor_Total).toFixed(2).replace('.', ',')}</div>
                `;
                container.appendChild(saleEl);
            });
        }
        
        // =================================================================
        // REGISTRAR VENDA
        // =================================================================
        function populateProductsForSale(productsToDisplay = null) {
            const container = document.getElementById('product-list-container');
            container.innerHTML = '';
            
            const activeProducts = productsToDisplay || allProducts.filter(p => p.Status === 'Ativo');

            if (activeProducts.length === 0) {
                container.innerHTML = '<p class="text-stone-500 col-span-full text-center">Nenhum produto encontrado.</p>';
                return;
            }
            
            activeProducts.forEach(product => {
                const productEl = document.createElement('div');
                productEl.className = 'bg-white border border-stone-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md hover:border-orange-400 transition-all';
                productEl.onclick = () => addToCart(product);
                productEl.innerHTML = `
                    <img src="${product.URL_Imagem || 'https://placehold.co/300x300/f97316/white?text=' + product.Nome_Produto.charAt(0)}" onerror="this.onerror=null;this.src='https://placehold.co/300x300/e7e5e4/57534e?text=Erro';" class="w-full h-24 object-cover rounded-md mb-2">
                    <h4 class="font-semibold text-sm truncate">${product.Nome_Produto}</h4>
                    <p class="text-stone-600">R$ ${parseFloat(product.Preco_Venda).toFixed(2).replace('.', ',')}</p>
                `;
                container.appendChild(productEl);
            });
        }

        function addToCart(product) {
            const existingItem = cart.find(item => item.Produto_ID === product.Produto_ID);
            if (existingItem) {
                existingItem.Quantidade++;
            } else {
                cart.push({ ...product, Quantidade: 1 });
            }
            updateCart();
        }

        function updateCart() {
            const container = document.getElementById('cart-items-container');
            const totalEl = document.getElementById('cart-total');
            const finalizeBtn = document.getElementById('finalize-sale-btn');
            container.innerHTML = '';

            if (cart.length === 0) {
                container.innerHTML = '<p class="text-stone-500">O carrinho está vazio.</p>';
                totalEl.textContent = 'R$ 0,00';
                finalizeBtn.disabled = true;
                return;
            }

            let total = 0;
            cart.forEach(item => {
                total += item.Preco_Venda * item.Quantidade;
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center justify-between text-sm';
                itemEl.innerHTML = `
                    <div>
                        <p class="font-medium">${item.Nome_Produto}</p>
                        <p class="text-stone-500">R$ ${parseFloat(item.Preco_Venda).toFixed(2).replace('.', ',')}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="changeQuantity('${item.Produto_ID}', -1)" class="w-6 h-6 bg-stone-200 rounded-full font-bold">-</button>
                        <span>${item.Quantidade}</span>
                        <button onclick="changeQuantity('${item.Produto_ID}', 1)" class="w-6 h-6 bg-stone-200 rounded-full font-bold">+</button>
                    </div>
                `;
                container.appendChild(itemEl);
            });

            totalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            finalizeBtn.disabled = false;
        }
        
        function changeQuantity(productId, amount) {
            const item = cart.find(i => i.Produto_ID === productId);
            if (item) {
                item.Quantidade += amount;
                if (item.Quantidade <= 0) {
                    cart = cart.filter(i => i.Produto_ID !== productId);
                }
                updateCart();
            }
        }

        async function handleFinalizeSale() {
            if (cart.length === 0) return;
            
            showGlobalLoader(true);

            const nextSaleId = allSales.length > 0 ? Math.max(...allSales.map(s => parseInt(s.Venda_ID) || 0)) + 1 : 1;
            
            const total = cart.reduce((sum, item) => sum + item.Preco_Venda * item.Quantidade, 0);

            const novaVenda = {
                Venda_ID: nextSaleId,
                Data_Venda: new Date().toISOString(),
                Valor_Total: total,
                Metodo_Pagamento: document.getElementById('metodo-pagamento').value,
                Turno: document.getElementById('turno-venda').value
            };

            const itensCarrinho = cart.map(item => ({
                Item_ID: `${nextSaleId}-${item.Produto_ID}`,
                Venda_Ref: nextSaleId,
                Produto_Ref: item.Produto_ID,
                Produto_Nome: item.Nome_Produto,
                Quantidade: item.Quantidade,
                Preco_Unitario: item.Preco_Venda,
                Subtotal: item.Quantidade * item.Preco_Venda
            }));
            
            try {
                const response = await postData({ action: 'saveSale', payload: { novaVenda, itensCarrinho } });
                if (response.status === 'success') {
                    showToast("Venda registrada com sucesso!", "success");
                    // Limpar e atualizar
                    cart = [];
                    updateCart();
                    await fetchAllData(); // Re-sincroniza com a planilha
                    showTab('painel-diario');
                } else {
                    throw new Error(response.message || 'Erro desconhecido ao salvar.');
                }
            } catch (error) {
                console.error("Erro ao finalizar venda:", error);
                showToast(`Erro ao salvar: ${error.message}`, "error");
            } finally {
                showGlobalLoader(false);
            }
        }

        // =================================================================
        // GERENCIAMENTO DE PRODUTOS
        // =================================================================
        function loadProductsForManagement() {
            const container = document.getElementById('product-management-container');
            container.innerHTML = `
                <table class="min-w-full divide-y divide-stone-200">
                    <thead class="bg-stone-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Produto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Categoria</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Preço</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-stone-200">
                        ${allProducts.map(p => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <img class="h-10 w-10 rounded-full object-cover" src="${p.URL_Imagem || 'https://placehold.co/100x100/f97316/white?text=' + p.Nome_Produto.charAt(0)}" alt="">
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-stone-900">${p.Nome_Produto}</div>
                                            <div class="text-sm text-stone-500">ID: ${p.Produto_ID}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${p.Categoria}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">R$ ${parseFloat(p.Preco_Venda).toFixed(2).replace('.', ',')}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${p.Status === 'Ativo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${p.Status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                    <button onclick="showProductModal('${p.Produto_ID}')" class="text-orange-600 hover:text-orange-900">Editar</button>
                                    ${p.Status === 'Ativo' ? 
                                      `<button onclick="confirmInactivateProduct('${p.Produto_ID}')" class="text-yellow-600 hover:text-yellow-900">Inativar</button>` :
                                      `<button onclick="confirmDeleteProduct('${p.Produto_ID}')" class="text-red-600 hover:text-red-900">Excluir</button>`
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function showProductModal(productId = null) {
            const form = document.getElementById('product-form');
            form.reset();
            populateCategoryFilter(); // Garante que as categorias estão no modal
            
            const modalTitle = document.getElementById('modal-title');
            if (productId) {
                const product = allProducts.find(p => p.Produto_ID == productId);
                modalTitle.textContent = "Editar Produto";
                document.getElementById('produto-id').value = product.Produto_ID;
                document.getElementById('produto-nome').value = product.Nome_Produto;
                document.getElementById('produto-categoria').value = product.Categoria;
                document.getElementById('produto-preco').value = product.Preco_Venda;
                document.getElementById('produto-imagem').value = product.URL_Imagem;
            } else {
                modalTitle.textContent = "Adicionar Novo Produto";
                document.getElementById('produto-id').value = '';
            }
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function hideProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        async function handleProductFormSubmit(e) {
            e.preventDefault();
            showGlobalLoader(true);
            
            const productId = document.getElementById('produto-id').value;
            const isEditing = !!productId;
            
            const nextId = allProducts.length > 0 ? Math.max(...allProducts.map(p => parseInt(p.Produto_ID) || 0)) + 1 : 1;

            const productData = {
                Produto_ID: isEditing ? productId : nextId,
                Nome_Produto: document.getElementById('produto-nome').value,
                Categoria: document.getElementById('produto-categoria').value,
                Preco_Venda: parseFloat(document.getElementById('produto-preco').value),
                URL_Imagem: document.getElementById('produto-imagem').value,
                Status: isEditing ? allProducts.find(p => p.Produto_ID == productId).Status : 'Ativo'
            };

            const action = isEditing ? 'updateProduct' : 'createProduct';

            try {
                const response = await postData({ action, payload: productData });
                if (response.status === 'success') {
                    showToast(`Produto ${isEditing ? 'atualizado' : 'criado'} com sucesso!`, "success");
                    hideProductModal();
                    await fetchAllData();
                    loadProductsForManagement();
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error(`Erro ao salvar produto:`, error);
                showToast(`Erro: ${error.message}`, "error");
            } finally {
                showGlobalLoader(false);
            }
        }

        function confirmInactivateProduct(productId) {
            showConfirmationModal(
                'Inativar Produto',
                'Tem certeza que deseja inativar este produto? Ele não aparecerá mais na tela de vendas.',
                async () => {
                    showGlobalLoader(true);
                    try {
                        const response = await postData({ action: 'inactivateProduct', payload: { Produto_ID: productId } });
                        if (response.status === 'success') {
                            showToast('Produto inativado com sucesso.', 'success');
                            await fetchAllData();
                            loadProductsForManagement();
                        } else {
                            throw new Error(response.message);
                        }
                    } catch (error) {
                        showToast(`Erro: ${error.message}`, 'error');
                    } finally {
                        showGlobalLoader(false);
                    }
                }
            );
        }

        function confirmDeleteProduct(productId) {
            showConfirmationModal(
                'Excluir Produto',
                'Atenção! Esta ação é permanente e não pode ser desfeita. Deseja realmente excluir este produto?',
                async () => {
                    showGlobalLoader(true);
                    try {
                        const response = await postData({ action: 'deleteProduct', payload: { Produto_ID: productId } });
                        if (response.status === 'success') {
                            showToast('Produto excluído permanentemente.', 'success');
                            await fetchAllData();
                            loadProductsForManagement();
                        } else {
                            throw new Error(response.message);
                        }
                    } catch (error) {
                        showToast(`Erro: ${error.message}`, 'error');
                    } finally {
                        showGlobalLoader(false);
                    }
                }
            );
        }

        // =================================================================
        // HISTÓRICO DE VENDAS
        // =================================================================
        function loadSalesHistory() {
            const container = document.getElementById('sales-history-container');
            container.innerHTML = '';

            const salesByYear = groupBy(allSales, sale => new Date(sale.Data_Venda).getFullYear());
            
            const sortedYears = Object.keys(salesByYear).sort((a, b) => b - a);

            sortedYears.forEach(year => {
                const yearAccordion = createAccordionItem(year);
                container.appendChild(yearAccordion.item);
                
                const salesByMonth = groupBy(salesByYear[year], sale => new Date(sale.Data_Venda).getMonth());
                const sortedMonths = Object.keys(salesByMonth).sort((a, b) => b - a);

                sortedMonths.forEach(monthIndex => {
                    const monthName = new Date(year, monthIndex).toLocaleString('pt-BR', { month: 'long' });
                    const monthAccordion = createAccordionItem(monthName.charAt(0).toUpperCase() + monthName.slice(1));
                    yearAccordion.content.appendChild(monthAccordion.item);

                    const salesByDay = groupBy(salesByMonth[monthIndex], sale => new Date(sale.Data_Venda).getDate());
                    const sortedDays = Object.keys(salesByDay).sort((a, b) => b - a);

                    sortedDays.forEach(day => {
                        const date = new Date(year, monthIndex, day);
                        const dayAccordion = createAccordionItem(`${date.toLocaleDateString('pt-BR')} - ${date.toLocaleDateString('pt-BR', { weekday: 'long' })}`);
                        monthAccordion.content.appendChild(dayAccordion.item);
                        
                        const salesOfTheDay = salesByDay[day].sort((a, b) => new Date(b.Data_Venda) - new Date(a.Data_Venda));
                        
                        salesOfTheDay.forEach(sale => {
                            const saleItems = allSaleItems.filter(item => item.Venda_Ref == sale.Venda_ID);
                            const saleDetail = document.createElement('div');
                            saleDetail.className = 'p-4 border-t border-stone-200';
                            saleDetail.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h5 class="font-bold">Venda #${sale.Venda_ID} - ${new Date(sale.Data_Venda).toLocaleTimeString('pt-BR')}</h5>
                                        <p class="text-sm text-stone-500">Pagamento: ${sale.Metodo_Pagamento} | Turno: ${sale.Turno}</p>
                                        <ul class="list-disc pl-5 mt-2 text-sm">
                                            ${saleItems.map(item => `<li>${item.Quantidade}x ${item.Produto_Nome} (R$ ${parseFloat(item.Subtotal).toFixed(2).replace('.',',')})</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-lg">R$ ${parseFloat(sale.Valor_Total).toFixed(2).replace('.',',')}</p>
                                        <button onclick="confirmDeleteSale('${sale.Venda_ID}')" class="text-red-500 hover:text-red-700 text-sm mt-2">Excluir Venda</button>
                                    </div>
                                </div>
                            `;
                            dayAccordion.content.appendChild(saleDetail);
                        });
                    });
                });
            });
        }

        function confirmDeleteSale(saleId) {
            showConfirmationModal(
                'Excluir Venda',
                `Deseja realmente excluir a venda #${saleId} e todos os seus itens? Esta ação é irreversível.`,
                async () => {
                    showGlobalLoader(true);
                    try {
                        const response = await postData({ action: 'deleteSale', payload: { Venda_ID: saleId } });
                        if (response.status === 'success') {
                            showToast('Venda excluída com sucesso.', 'success');
                            await fetchAllData();
                            loadSalesHistory();
                        } else {
                            throw new Error(response.message);
                        }
                    } catch (error) {
                        showToast(`Erro ao excluir: ${error.message}`, 'error');
                    } finally {
                        showGlobalLoader(false);
                    }
                }
            );
        }

        // =================================================================
        // FUNÇÕES UTILITÁRIAS E COMPONENTES
        // =================================================================
        async function postData(data) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit',
                    headers: { 'Content-Type': 'text/plain;charset=utf-t' }, // Workaround for CORS
                    body: JSON.stringify(data),
                    redirect: 'follow'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Erro no POST:', error);
                throw error;
            }
        }

        function populateCategoryFilter() {
            const select = document.getElementById('produto-categoria');
            select.innerHTML = '<option value="">Selecione...</option>';
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.Nome_Categoria;
                option.textContent = cat.Nome_Categoria;
                select.appendChild(option);
            });
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.className = 'fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transform transition-all duration-300 ease-out z-50'; // Reset
            
            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-stone-800');
            }

            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 4000);
        }
        
        function showGlobalLoader(isLoading) {
            let loader = document.getElementById('global-loader');
            if (isLoading) {
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'global-loader';
                    loader.className = 'fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50';
                    loader.innerHTML = '<div class="loader"></div>';
                    document.body.appendChild(loader);
                }
                loader.classList.remove('hidden');
            } else {
                if (loader) {
                    loader.classList.add('hidden');
                }
            }
        }
        
        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            // Clone and replace to remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.onclick = () => {
                hideConfirmationModal();
                onConfirm();
            };

            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }
        
        function groupBy(array, keyGetter) {
            const map = new Map();
            array.forEach((item) => {
                 const key = keyGetter(item);
                 const collection = map.get(key);
                 if (!collection) {
                     map.set(key, [item]);
                 } else {
                     collection.push(item);
                 }
            });
            return Object.fromEntries(map);
        }
        
        function createAccordionItem(title) {
            const item = document.createElement('div');
            item.className = 'accordion-item border border-stone-200 rounded-lg';
            
            const header = document.createElement('div');
            header.className = 'accordion-header flex justify-between items-center p-4 cursor-pointer hover:bg-stone-50';
            header.innerHTML = `<h4 class="font-semibold">${title}</h4><svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
            
            const content = document.createElement('div');
            content.className = 'accordion-content bg-stone-50/50';
            
            item.appendChild(header);
            item.appendChild(content);
            
            header.addEventListener('click', () => {
                item.classList.toggle('open');
                const icon = header.querySelector('svg');
                icon.classList.toggle('rotate-180');
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
            
            return { item, content };
        }

    </script>
</body>
</html>

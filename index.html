<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Cantina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-button.active { background-color: #f97316; color: white; }
        .nav-button { transition: all 0.2s ease-in-out; text-align: left; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-header-icon { transition: transform 0.3s ease-out; }
        .open > .accordion-header .accordion-header-icon { transform: rotate(90deg); }
        .modal-overlay { transition: opacity 0.2s ease-in-out; }
        .sort-button.active { background-color: #ea580c; color: white; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div class="md:grid md:grid-cols-[280px_1fr] min-h-screen">
        <!-- Barra Lateral de Navegação -->
        <aside class="bg-white p-6 flex flex-col border-r border-stone-200">
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-stone-900">Painel da Cantina</h1>
                <p class="text-stone-600 text-sm">Gerencie seu negócio</p>
            </header>

            <nav class="flex flex-col gap-3">
                <button data-view="painel" class="nav-button active w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Painel Diário</button>
                <button data-view="registrar" class="nav-button w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Registrar Venda</button>
                <button data-view="produtos" class="nav-button w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Produtos</button>
                <button data-view="historico" class="nav-button w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Histórico</button>
            </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <div class="p-4 md:p-8 overflow-y-auto">
            <main>
                <!-- Seção 1: Painel Diário -->
                <section id="painel" class="view">
                    <h2 class="text-2xl font-bold mb-4">Resumo de Hoje</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="font-semibold text-stone-500">Vendas Totais Hoje</h3>
                            <p id="total-hoje" class="text-4xl font-bold text-orange-600">R$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="font-semibold text-stone-500">Total em PIX</h3>
                            <p id="total-pix-hoje" class="text-4xl font-bold text-sky-600">R$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="font-semibold text-stone-500">Total em Dinheiro</h3>
                            <p id="total-dinheiro-hoje" class="text-4xl font-bold text-emerald-600">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold text-stone-500 mb-3">Vendas Realizadas Hoje</h3>
                        <div id="lista-vendas-hoje" class="space-y-2">
                            <p class="text-stone-500">Nenhuma venda registrada hoje.</p>
                        </div>
                    </div>
                </section>

                <!-- Seção 2: Registrar Venda -->
                <section id="registrar" class="view hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Produtos Disponíveis</h2>
                            <div id="lista-produtos-venda" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto p-2">
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex flex-col">
                            <h2 class="text-2xl font-bold mb-4">Carrinho</h2>
                            <div class="space-y-3 mb-4">
                                <div>
                                    <label for="nome-comprador" class="block text-sm font-medium text-stone-700">Nome do Comprador</label>
                                    <input type="text" id="nome-comprador" class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-stone-700">Forma de Pagamento</label>
                                    <div class="flex gap-2 mt-1">
                                        <button data-pagamento="PIX" class="pagamento-btn flex-1 bg-stone-200 text-stone-700 py-2 rounded-lg">PIX</button>
                                        <button data-pagamento="Dinheiro" class="pagamento-btn flex-1 bg-stone-200 text-stone-700 py-2 rounded-lg">Dinheiro</button>
                                    </div>
                                </div>
                            </div>
                            <div id="carrinho-itens" class="space-y-2 mb-4 flex-grow overflow-y-auto">
                                <p class="text-stone-500 text-center pt-8">Carrinho vazio.</p>
                            </div>
                            <div class="border-t pt-4">
                                <div class="flex justify-between items-center font-bold text-xl">
                                    <span>Total:</span>
                                    <span id="carrinho-total">R$ 0,00</span>
                                </div>
                                <button id="salvar-venda" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg mt-4 hover:bg-orange-600 disabled:bg-stone-300">Salvar Venda</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção 3: Produtos -->
                <section id="produtos" class="view hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Catálogo de Produtos</h2>
                        <button id="add-new-product-btn" class="bg-orange-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-orange-600 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            <span>Novo Produto</span>
                        </button>
                    </div>
                    <div class="flex gap-2 mb-4 border-b border-stone-200">
                        <button data-status="Ativo" class="status-tab-btn active pb-2 border-b-2 border-orange-500 font-semibold">Ativos</button>
                        <button data-status="Inativo" class="status-tab-btn pb-2 border-b-2 border-transparent text-stone-500 font-semibold">Inativos</button>
                    </div>
                    <div id="lista-produtos-catalogo" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    </div>
                </section>

                <!-- Seção 4: Histórico -->
                <section id="historico" class="view hidden">
                    <h2 class="text-2xl font-bold mb-4">Histórico de Vendas</h2>
                    
                    <!-- NOVOS CONTROLOS DE ORDENAÇÃO -->
                    <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                        <div class="flex flex-wrap gap-4 items-center">
                            <span class="font-semibold">Ordenar por:</span>
                            <div class="flex gap-2" id="sort-by-group">
                                <button data-sort="data" class="sort-button active px-3 py-1 rounded-lg text-sm">Data</button>
                                <button data-sort="valor" class="sort-button px-3 py-1 rounded-lg text-sm">Valor</button>
                                <button data-sort="nome" class="sort-button px-3 py-1 rounded-lg text-sm">Nome</button>
                            </div>
                            <div class="flex gap-2" id="sort-order-group">
                                <button data-order="decrescente" class="sort-button active px-3 py-1 rounded-lg text-sm">Decrescente</button>
                                <button data-order="crescente" class="sort-button px-3 py-1 rounded-lg text-sm">Crescente</button>
                            </div>
                        </div>
                    </div>

                    <div id="historico-lista-container" class="bg-white p-6 rounded-xl shadow-md space-y-1">
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Modal de Edição/Criação de Produto -->
    <div id="product-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h2 id="product-modal-title" class="text-2xl font-bold mb-4">Editar Produto</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-stone-700">Nome do Produto</label>
                        <input type="text" id="product-name" required class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div>
                        <label for="product-price" class="block text-sm font-medium text-stone-700">Preço</label>
                        <input type="number" step="0.01" id="product-price" required class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div>
                        <label for="product-description" class="block text-sm font-medium text-stone-700">Descrição</label>
                        <textarea id="product-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></textarea>
                    </div>
                    <div>
                        <label for="product-status" class="block text-sm font-medium text-stone-700">Status</label>
                        <select id="product-status" class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-product-modal" class="px-4 py-2 bg-stone-200 text-stone-800 font-semibold rounded-lg hover:bg-stone-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const API_ENDPOINT = '/.netlify/functions/sheets';

            const SHEET_GIDS = {
                produtos: 0, // Substitua pelo GID real da aba 'produtos'
                vendas: 123456789, // Substitua pelo GID real da aba 'vendas'
                itens_venda: 987654321 // Substitua pelo GID real da aba 'itens_venda'
            };

            let DB = {
                produtos: [],
                categorias: [],
                imagens: [],
                vendas: [],
                itens_venda: []
            };

            async function fetchData() {
                showLoading(true);
                try {
                    const sheetsToFetch = ['produtos', 'categorias', 'imagens', 'vendas', 'itens_venda'];
                    const processResponse = async (response, sheetName) => {
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ message: 'Resposta inválida do servidor.' }));
                            throw new Error(`Falha ao buscar a aba '${sheetName}'. Status: ${response.status}. Mensagem: ${errorData.error || 'Erro desconhecido'}`);
                        }
                        return response.json();
                    };

                    for (const sheet of sheetsToFetch) {
                        DB[sheet] = await fetch(`${API_ENDPOINT}?sheet=${sheet}`).then(res => processResponse(res, sheet));
                    }
                    
                    renderCurrentView();
                } catch (error) {
                    alert(`Ocorreu um erro crítico ao carregar os dados:\n\n${error.message}`);
                    console.error("=== ERRO DETALHADO EM fetchData ===", error);
                } finally {
                    showLoading(false);
                }
            }
            
            function showLoading(isLoading) {
                let overlay = document.getElementById('loading-overlay');
                if (isLoading) {
                    if (!overlay) {
                        document.body.insertAdjacentHTML('beforeend', '<div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50"><p class="text-lg font-semibold">Carregando dados...</p></div>');
                    }
                } else {
                    if (overlay) overlay.remove();
                }
            }

            const appState = {
                currentView: 'painel',
                carrinho: [],
                pagamento: null,
                activeProductStatusTab: 'Ativo',
                // NOVO ESTADO PARA ORDENAÇÃO
                historicoSortBy: 'data', // 'data', 'valor', 'nome'
                historicoSortOrder: 'decrescente' // 'crescente', 'decrescente'
            };

            const formatCurrency = (value) => {
                const numValue = parseFloat(value);
                if (isNaN(numValue)) return 'R$ 0,00';
                return `R$ ${numValue.toFixed(2).replace('.', ',')}`;
            }

            const getTodayString = () => new Date().toISOString().split('T')[0];
            
            const navButtons = document.querySelectorAll('.nav-button');
            const views = document.querySelectorAll('.view');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    appState.currentView = button.dataset.view;
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    views.forEach(view => view.classList.toggle('hidden', view.id !== appState.currentView));
                    renderCurrentView();
                });
            });

            function renderCurrentView() {
                const renderMap = {
                    painel: renderPainelDiario,
                    registrar: renderRegistrarVenda,
                    produtos: renderProdutos,
                    historico: renderHistorico,
                };
                renderMap[appState.currentView]();
            }
            
            // ... (O resto do seu JavaScript permanece igual até a função renderHistorico)
            
            document.getElementById('salvar-venda').addEventListener('click', async () => {
                const saveButton = document.getElementById('salvar-venda');
                saveButton.disabled = true;
                saveButton.textContent = 'Salvando...';

                const dataAtual = new Date();
                const novaVenda = {
                    Venda_ID: `V${Date.now()}`,
                    NomeComprador: document.getElementById('nome-comprador').value || 'Cliente',
                    Data: dataAtual.toISOString().split('T')[0],
                    TimestampVenda: dataAtual.toISOString(),
                    Turno: dataAtual.getHours() >= 14 ? 'Noite' : 'Manhã',
                    FormaPagamento: appState.pagamento,
                    TotalVenda: appState.carrinho.reduce((sum, item) => sum + (parseFloat(item.Preco || 0) * item.Quantidade), 0),
                    Ano: dataAtual.getFullYear().toString(),
                };

                const itensCarrinho = appState.carrinho.map(item => ({
                    ItemVenda_ID: `IV${Date.now()}${item.Produto_ID}`,
                    Venda_Ref: novaVenda.Venda_ID,
                    Produto_Ref: item.Produto_ID,
                    Quantidade: item.Quantidade,
                    PrecoUnitario: parseFloat(item.Preco || 0),
                    Subtotal: parseFloat(item.Preco || 0) * item.Quantidade,
                }));
                
                DB.vendas.push(novaVenda);
                DB.itens_venda.push(...itensCarrinho);
                
                const carrinhoOriginal = [...appState.carrinho];
                appState.carrinho = [];
                appState.pagamento = null;
                document.getElementById('nome-comprador').value = '';
                document.querySelectorAll('.pagamento-btn').forEach(b => b.classList.remove('bg-orange-500', 'text-white'));
                renderCarrinho();
                alert('Venda salva com sucesso!');

                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'saveSale', payload: { novaVenda, itensCarrinho } }),
                    });
                    if (!response.ok) throw new Error((await response.json()).error);
                } catch (error) {
                    alert(`ERRO: A venda não pôde ser salva na planilha. Por favor, recarregue a página. Detalhes: ${error.message}`);
                    DB.vendas = DB.vendas.filter(v => v.Venda_ID !== novaVenda.Venda_ID);
                    DB.itens_venda = DB.itens_venda.filter(i => i.Venda_Ref !== novaVenda.Venda_ID);
                    appState.carrinho = carrinhoOriginal;
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Salvar Venda';
                }
            });

            document.getElementById('product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const productId = document.getElementById('product-id').value;
                const isUpdating = !!productId;

                const productData = {
                    Produto_ID: isUpdating ? productId : `P${Date.now()}`,
                    Nome: document.getElementById('product-name').value,
                    Preco: document.getElementById('product-price').value,
                    Descricao: document.getElementById('product-description').value,
                    Status: document.getElementById('product-status').value,
                    Categoria_Ref: '', 
                    Imagem_Ref: '',
                };
                
                const originalProduct = isUpdating ? { ...DB.produtos.find(p => p.Produto_ID === productId) } : null;

                if (isUpdating) {
                    const productIndex = DB.produtos.findIndex(p => p.Produto_ID === productId);
                    DB.produtos[productIndex] = productData;
                } else {
                    DB.produtos.push(productData);
                }
                renderProdutos();
                closeProductModal();
                
                const action = isUpdating ? 'updateProduct' : 'createProduct';
                
                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        body: JSON.stringify({ action, payload: productData }),
                    });
                    if (!response.ok) throw new Error((await response.json()).error);
                    alert(`Produto ${isUpdating ? 'atualizado' : 'adicionado'} com sucesso!`);
                } catch (error) {
                    alert(`Erro ao salvar produto: ${error.message}`);
                    if (isUpdating) {
                        const productIndex = DB.produtos.findIndex(p => p.Produto_ID === productId);
                        DB.produtos[productIndex] = originalProduct;
                    } else {
                        DB.produtos = DB.produtos.filter(p => p.Produto_ID !== productData.Produto_ID);
                    }
                    renderProdutos();
                }
            });

            async function handleDeleteProduct(productId) {
                if (confirm('Tem certeza que deseja processar este produto? Se ele tiver vendas, será inativado. Caso contrário, será excluído.')) {
                    
                    const productIndex = DB.produtos.findIndex(p => p.Produto_ID === productId);
                    const product = DB.produtos[productIndex];
                    const originalProduct = { ...product };

                    DB.produtos = DB.produtos.filter(p => p.Produto_ID !== productId);
                    renderProdutos();

                    try {
                        const response = await fetch(API_ENDPOINT, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'handleDeleteProduct',
                                payload: {
                                    productId: productId,
                                    productSheetGid: SHEET_GIDS.produtos
                                }
                            }),
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error);
                        
                        alert(result.message);
                        if (result.message.includes('inativado')) {
                            await fetchData();
                        }

                    } catch (error) {
                        alert(`Erro ao processar produto: ${error.message}`);
                        DB.produtos.splice(productIndex, 0, originalProduct);
                        renderProdutos();
                    }
                }
            }

            // =================================================================
            // FUNÇÃO DE HISTÓRICO ATUALIZADA
            // =================================================================

            function renderHistorico() {
                const container = document.getElementById('historico-lista-container');
                container.innerHTML = '';
                if (!DB.vendas || DB.vendas.length === 0) {
                    container.innerHTML = '<p class="text-stone-500">Nenhum histórico de vendas encontrado.</p>';
                    return;
                }

                const mesesNomes = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const diasNomes = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];

                const dadosAgrupados = DB.vendas.reduce((acc, venda) => {
                    if (!venda.Data) return acc;
                    const data = new Date(venda.Data + 'T12:00:00Z');
                    if (isNaN(data.getTime())) return acc;

                    const ano = data.getUTCFullYear();
                    const mes = data.getUTCMonth();
                    const semanaDoMes = Math.ceil(data.getUTCDate() / 7);
                    const diaDoMes = data.getUTCDate();
                    const diaDaSemana = diasNomes[data.getUTCDay()];
                    const turno = venda.Turno || 'Indefinido';
                    
                    if (!acc[ano]) acc[ano] = { total: 0, meses: {} };
                    if (!acc[ano].meses[mes]) acc[ano].meses[mes] = { total: 0, semanas: {} };
                    if (!acc[ano].meses[mes].semanas[semanaDoMes]) acc[ano].meses[mes].semanas[semanaDoMes] = { total: 0, dias: {} };
                    if (!acc[ano].meses[mes].semanas[semanaDoMes].dias[diaDoMes]) acc[ano].meses[mes].semanas[semanaDoMes].dias[diaDoMes] = { total: 0, nome: `${diaDoMes} - ${diaDaSemana}`, turnos: {} };
                    if (!acc[ano].meses[mes].semanas[semanaDoMes].dias[diaDoMes].turnos[turno]) acc[ano].meses[mes].semanas[semanaDoMes].dias[diaDoMes].turnos[turno] = { total: 0, vendas: [] };

                    const totalVenda = parseFloat(venda.TotalVenda || 0);
                    acc[ano].total += totalVenda;
                    acc[ano].meses[mes].total += totalVenda;
                    acc[ano].meses[mes].semanas[semanaDoMes].total += totalVenda;
                    acc[ano].meses[mes].semanas[semanaDoMes].dias[diaDoMes].total += totalVenda;
                    acc[ano].meses[mes].semanas[semanaDoMes].dias[diaDoMes].turnos[turno].total += totalVenda;
                    acc[ano].meses[mes].semanas[semanaDoMes].dias[diaDoMes].turnos[turno].vendas.push(venda);
                    
                    return acc;
                }, {});

                const createAccordionLevel = (title, total, content, level) => {
                    const paddingLeft = level * 1.5;
                    const textSize = level < 2 ? 'text-lg' : 'text-base';
                    return `
                        <div class="accordion-item border-b border-stone-200 last:border-b-0">
                            <div class="accordion-header flex justify-between items-center cursor-pointer p-2 hover:bg-stone-100 rounded-md" style="padding-left: ${paddingLeft}rem;">
                                <div class="flex items-center gap-3">
                                    <span class="accordion-header-icon font-bold text-orange-600">▶</span>
                                    <span class="font-semibold ${textSize}">${title}</span>
                                </div>
                                <span class="font-semibold ${textSize}">${formatCurrency(total)}</span>
                            </div>
                            <div class="accordion-content pl-4">${content}</div>
                        </div>`;
                };
                
                let html = '';
                const sortOrderFactor = appState.historicoSortOrder === 'crescente' ? 1 : -1;

                Object.keys(dadosAgrupados).sort((a, b) => (b - a) * sortOrderFactor).forEach(ano => {
                    let mesesHtml = '';
                    Object.keys(dadosAgrupados[ano].meses).sort((a, b) => (b - a) * sortOrderFactor).forEach(mesIdx => {
                        let semanasHtml = '';
                        Object.keys(dadosAgrupados[ano].meses[mesIdx].semanas).sort((a, b) => (b - a) * sortOrderFactor).forEach(semanaNum => {
                            let diasHtml = '';
                            Object.keys(dadosAgrupados[ano].meses[mesIdx].semanas[semanaNum].dias).sort((a, b) => (b - a) * sortOrderFactor).forEach(diaNum => {
                                let turnosHtml = '';
                                const diaData = dadosAgrupados[ano].meses[mesIdx].semanas[semanaNum].dias[diaNum];
                                Object.keys(diaData.turnos).sort().forEach(turno => {
                                    const turnoData = diaData.turnos[turno];
                                    
                                    // Aplicar ordenação à lista final de vendas
                                    const sortedVendas = [...turnoData.vendas].sort((a, b) => {
                                        if (appState.historicoSortBy === 'valor') {
                                            return (parseFloat(a.TotalVenda) - parseFloat(b.TotalVenda)) * sortOrderFactor;
                                        }
                                        if (appState.historicoSortBy === 'nome') {
                                            return a.NomeComprador.localeCompare(b.NomeComprador) * sortOrderFactor;
                                        }
                                        // Padrão é por data (timestamp)
                                        return (new Date(b.TimestampVenda) - new Date(a.TimestampVenda)) * sortOrderFactor;
                                    });

                                    let vendasHtml = sortedVendas.map(venda => `
                                        <div class="flex justify-between items-center p-2 bg-stone-50 rounded-lg my-1">
                                            <span>${venda.NomeComprador || 'Cliente'} (${venda.FormaPagamento})</span>
                                            <span class="font-bold">${formatCurrency(venda.TotalVenda)}</span>
                                        </div>`).join('');

                                    turnosHtml += createAccordionLevel(`Turno ${turno}`, turnoData.total, `<div class="p-2">${vendasHtml}</div>`, 4);
                                });
                                diasHtml += createAccordionLevel(diaData.nome, diaData.total, turnosHtml, 3);
                            });
                            semanasHtml += createAccordionLevel(`Semana ${semanaNum}`, dadosAgrupados[ano].meses[mesIdx].semanas[semanaNum].total, diasHtml, 2);
                        });
                        mesesHtml += createAccordionLevel(mesesNomes[mesIdx], dadosAgrupados[ano].meses[mesIdx].total, semanasHtml, 1);
                    });
                    html += createAccordionLevel(ano, dadosAgrupados[ano].total, mesesHtml, 0);
                });

                container.innerHTML = html;

                container.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        const item = e.currentTarget.closest('.accordion-item');
                        const content = item.querySelector('.accordion-content');
                        item.classList.toggle('open');
                        content.style.maxHeight = item.classList.contains('open') ? `${content.scrollHeight}px` : null;
                    });
                });
            }
            
            // Event Listeners para os botões de ordenação
            document.getElementById('sort-by-group').addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    appState.historicoSortBy = e.target.dataset.sort;
                    document.querySelectorAll('#sort-by-group button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderHistorico();
                }
            });
            
            document.getElementById('sort-order-group').addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    appState.historicoSortOrder = e.target.dataset.order;
                    document.querySelectorAll('#sort-order-group button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderHistorico();
                }
            });

            fetchData();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Cantina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-button.active { background-color: #f97316; color: white; }
        .nav-button { transition: all 0.2s ease-in-out; text-align: left; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-header-icon { transition: transform 0.3s ease-out; }
        .open .accordion-header-icon { transform: rotate(90deg); }
        .modal-overlay { transition: opacity 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div class="md:grid md:grid-cols-[280px_1fr] min-h-screen">
        <!-- Barra Lateral de Navegação -->
        <aside class="bg-white p-6 flex flex-col border-r border-stone-200">
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-stone-900">Painel da Cantina</h1>
                <p class="text-stone-600 text-sm">Gerencie seu negócio</p>
            </header>

            <nav class="flex flex-col gap-3">
                <button data-view="painel" class="nav-button active w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Painel Diário</button>
                <button data-view="registrar" class="nav-button w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Registrar Venda</button>
                <button data-view="produtos" class="nav-button w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Produtos</button>
                <button data-view="historico" class="nav-button w-full px-4 py-3 rounded-lg font-semibold text-stone-700 hover:bg-orange-500 hover:text-white">Histórico</button>
            </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <div class="p-4 md:p-8 overflow-y-auto">
            <main>
                <!-- Seção 1: Painel Diário -->
                <section id="painel" class="view">
                    <h2 class="text-2xl font-bold mb-4">Resumo de Hoje</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="font-semibold text-stone-500">Vendas Totais Hoje</h3>
                            <p id="total-hoje" class="text-4xl font-bold text-orange-600">R$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="font-semibold text-stone-500">Total em PIX</h3>
                            <p id="total-pix-hoje" class="text-4xl font-bold text-sky-600">R$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="font-semibold text-stone-500">Total em Dinheiro</h3>
                            <p id="total-dinheiro-hoje" class="text-4xl font-bold text-emerald-600">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold text-stone-500 mb-3">Vendas Realizadas Hoje</h3>
                        <div id="lista-vendas-hoje" class="space-y-2">
                            <p class="text-stone-500">Nenhuma venda registrada hoje.</p>
                        </div>
                    </div>
                </section>

                <!-- Seção 2: Registrar Venda -->
                <section id="registrar" class="view hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Produtos Disponíveis</h2>
                            <div id="lista-produtos-venda" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto p-2">
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex flex-col">
                            <h2 class="text-2xl font-bold mb-4">Carrinho</h2>
                            <div class="space-y-3 mb-4">
                                <div>
                                    <label for="nome-comprador" class="block text-sm font-medium text-stone-700">Nome do Comprador</label>
                                    <input type="text" id="nome-comprador" class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-stone-700">Forma de Pagamento</label>
                                    <div class="flex gap-2 mt-1">
                                        <button data-pagamento="PIX" class="pagamento-btn flex-1 bg-stone-200 text-stone-700 py-2 rounded-lg">PIX</button>
                                        <button data-pagamento="Dinheiro" class="pagamento-btn flex-1 bg-stone-200 text-stone-700 py-2 rounded-lg">Dinheiro</button>
                                    </div>
                                </div>
                            </div>
                            <div id="carrinho-itens" class="space-y-2 mb-4 flex-grow overflow-y-auto">
                                <p class="text-stone-500 text-center pt-8">Carrinho vazio.</p>
                            </div>
                            <div class="border-t pt-4">
                                <div class="flex justify-between items-center font-bold text-xl">
                                    <span>Total:</span>
                                    <span id="carrinho-total">R$ 0,00</span>
                                </div>
                                <button id="salvar-venda" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg mt-4 hover:bg-orange-600 disabled:bg-stone-300">Salvar Venda</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção 3: Produtos -->
                <section id="produtos" class="view hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Catálogo de Produtos</h2>
                        <button id="add-new-product-btn" class="bg-orange-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-orange-600 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            <span>Novo Produto</span>
                        </button>
                    </div>
                    <div class="flex gap-2 mb-4 border-b border-stone-200">
                        <button data-status="Ativo" class="status-tab-btn active pb-2 border-b-2 border-orange-500 font-semibold">Ativos</button>
                        <button data-status="Inativo" class="status-tab-btn pb-2 border-b-2 border-transparent text-stone-500 font-semibold">Inativos</button>
                    </div>
                    <div id="lista-produtos-catalogo" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    </div>
                </section>

                <!-- Seção 4: Histórico -->
                <section id="historico" class="view hidden">
                    <h2 class="text-2xl font-bold mb-4">Histórico de Vendas</h2>
                    <div id="historico-lista-container" class="bg-white p-6 rounded-xl shadow-md space-y-2">
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- Modal de Edição/Criação de Produto -->
    <div id="product-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h2 id="product-modal-title" class="text-2xl font-bold mb-4">Editar Produto</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-stone-700">Nome do Produto</label>
                        <input type="text" id="product-name" required class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div>
                        <label for="product-price" class="block text-sm font-medium text-stone-700">Preço</label>
                        <input type="number" step="0.01" id="product-price" required class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div>
                        <label for="product-description" class="block text-sm font-medium text-stone-700">Descrição</label>
                        <textarea id="product-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"></textarea>
                    </div>
                    <div>
                        <label for="product-status" class="block text-sm font-medium text-stone-700">Status</label>
                        <select id="product-status" class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-product-modal" class="px-4 py-2 bg-stone-200 text-stone-800 font-semibold rounded-lg hover:bg-stone-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const API_ENDPOINT = '/.netlify/functions/sheets';

            let DB = {
                produtos: [],
                categorias: [],
                imagens: [],
                vendas: [],
                itens_venda: []
            };

            async function fetchData() {
                showLoading(true);
                try {
                    const sheetsToFetch = ['produtos', 'categorias', 'imagens', 'vendas', 'itens_venda'];
                    
                    const processResponse = async (response, sheetName) => {
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ message: 'Resposta inválida do servidor.' }));
                            throw new Error(`Falha ao buscar a aba '${sheetName}'. Status: ${response.status}. Mensagem: ${errorData.message || 'Erro desconhecido'}`);
                        }
                        return response.json();
                    };

                    DB.produtos = await fetch(`${API_ENDPOINT}?sheet=produtos`).then(res => processResponse(res, 'produtos'));
                    DB.categorias = await fetch(`${API_ENDPOINT}?sheet=categorias`).then(res => processResponse(res, 'categorias'));
                    DB.imagens = await fetch(`${API_ENDPOINT}?sheet=imagens`).then(res => processResponse(res, 'imagens'));
                    DB.vendas = await fetch(`${API_ENDPOINT}?sheet=vendas`).then(res => processResponse(res, 'vendas'));
                    DB.itens_venda = await fetch(`${API_ENDPOINT}?sheet=itens_venda`).then(res => processResponse(res, 'itens_venda'));
                    
                    renderCurrentView();

                } catch (error) {
                    alert(`Ocorreu um erro crítico ao carregar os dados:\n\n${error.message}`);
                    console.error("=== ERRO DETALHADO EM fetchData ===", error);
                } finally {
                    showLoading(false);
                }
            }
            
            function showLoading(isLoading) {
                let overlay = document.getElementById('loading-overlay');
                if (isLoading) {
                    if (!overlay) {
                        document.body.insertAdjacentHTML('beforeend', '<div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50"><p class="text-lg font-semibold">Carregando dados...</p></div>');
                    }
                } else {
                    if (overlay) overlay.remove();
                }
            }

            const appState = {
                currentView: 'painel',
                carrinho: [],
                pagamento: null,
                activeProductStatusTab: 'Ativo'
            };

            const formatCurrency = (value) => {
                const numValue = parseFloat(value);
                if (isNaN(numValue)) return 'R$ 0,00';
                return `R$ ${numValue.toFixed(2).replace('.', ',')}`;
            }

            const getTodayString = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            const navButtons = document.querySelectorAll('.nav-button');
            const views = document.querySelectorAll('.view');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const viewName = button.dataset.view;
                    appState.currentView = viewName;
                    
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    views.forEach(view => {
                        if (view.id === viewName) {
                            view.classList.remove('hidden');
                        } else {
                            view.classList.add('hidden');
                        }
                    });
                    renderCurrentView();
                });
            });

            function renderCurrentView() {
                switch (appState.currentView) {
                    case 'painel': renderPainelDiario(); break;
                    case 'registrar': renderRegistrarVenda(); break;
                    case 'produtos': renderProdutos(); break;
                    case 'historico': renderHistorico(); break;
                }
            }

            function renderPainelDiario() {
                const hoje = getTodayString();
                const vendasHoje = DB.vendas.filter(v => v.Data && v.Data.startsWith(hoje));

                const totalHoje = vendasHoje.reduce((sum, v) => sum + parseFloat(v.TotalVenda || 0), 0);
                const totalPix = vendasHoje.filter(v => v.FormaPagamento === 'PIX').reduce((sum, v) => sum + parseFloat(v.TotalVenda || 0), 0);
                const totalDinheiro = vendasHoje.filter(v => v.FormaPagamento === 'Dinheiro').reduce((sum, v) => sum + parseFloat(v.TotalVenda || 0), 0);

                document.getElementById('total-hoje').textContent = formatCurrency(totalHoje);
                document.getElementById('total-pix-hoje').textContent = formatCurrency(totalPix);
                document.getElementById('total-dinheiro-hoje').textContent = formatCurrency(totalDinheiro);

                const listaVendasEl = document.getElementById('lista-vendas-hoje');
                listaVendasEl.innerHTML = '';
                if (vendasHoje.length === 0) {
                    listaVendasEl.innerHTML = '<p class="text-stone-500">Nenhuma venda registrada hoje.</p>';
                    return;
                }
                vendasHoje.forEach(venda => {
                    const vendaEl = document.createElement('div');
                    vendaEl.className = 'flex justify-between items-center p-2 bg-stone-100 rounded-lg';
                    vendaEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${venda.NomeComprador || 'Cliente'}</p>
                            <p class="text-sm text-stone-500">${venda.FormaPagamento}</p>
                        </div>
                        <p class="font-bold">${formatCurrency(venda.TotalVenda)}</p>
                    `;
                    listaVendasEl.appendChild(vendaEl);
                });
            }

            function renderRegistrarVenda() {
                const listaProdutosEl = document.getElementById('lista-produtos-venda');
                listaProdutosEl.innerHTML = '';
                DB.produtos.filter(p => p.Status === 'Ativo').forEach(produto => {
                    const produtoCard = document.createElement('div');
                    produtoCard.className = 'p-3 bg-stone-100 rounded-lg text-center cursor-pointer hover:bg-orange-100 transition-colors';
                    produtoCard.innerHTML = `
                        <p class="font-semibold">${produto.Nome}</p>
                        <p class="text-sm text-stone-600">${formatCurrency(produto.Preco)}</p>
                    `;
                    produtoCard.addEventListener('click', () => adicionarAoCarrinho(produto.Produto_ID));
                    listaProdutosEl.appendChild(produtoCard);
                });
                renderCarrinho();
                setupPagamentoButtons();
            }
            
            function adicionarAoCarrinho(produtoId) {
                const itemExistente = appState.carrinho.find(item => item.Produto_ID === produtoId);
                if (itemExistente) {
                    itemExistente.Quantidade++;
                } else {
                    const produto = DB.produtos.find(p => p.Produto_ID === produtoId);
                    appState.carrinho.push({ ...produto, Quantidade: 1 });
                }
                renderCarrinho();
            }

            function renderCarrinho() {
                const carrinhoItensEl = document.getElementById('carrinho-itens');
                carrinhoItensEl.innerHTML = '';
                if (appState.carrinho.length === 0) {
                    carrinhoItensEl.innerHTML = '<p class="text-stone-500 text-center pt-8">Carrinho vazio.</p>';
                } else {
                    appState.carrinho.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex items-center justify-between p-2 rounded-md hover:bg-stone-50';
                        const precoTotalItem = parseFloat(item.Preco || 0) * item.Quantidade;
                        itemEl.innerHTML = `
                            <div>
                                <p class="font-semibold">${item.Nome}</p>
                                <p class="text-sm text-stone-500">${formatCurrency(precoTotalItem)}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-id="${item.Produto_ID}" class="diminuir-item bg-stone-200 w-7 h-7 rounded-full font-bold hover:bg-red-200">-</button>
                                <span>${item.Quantidade}</span>
                                <button data-id="${item.Produto_ID}" class="aumentar-item bg-stone-200 w-7 h-7 rounded-full font-bold hover:bg-green-200">+</button>
                            </div>
                        `;
                        carrinhoItensEl.appendChild(itemEl);
                    });
                }
                
                document.querySelectorAll('.aumentar-item').forEach(btn => btn.addEventListener('click', (e) => alterarQuantidade(e.target.dataset.id, 1)));
                document.querySelectorAll('.diminuir-item').forEach(btn => btn.addEventListener('click', (e) => alterarQuantidade(e.target.dataset.id, -1)));

                const total = appState.carrinho.reduce((sum, item) => sum + (parseFloat(item.Preco || 0) * item.Quantidade), 0);
                document.getElementById('carrinho-total').textContent = formatCurrency(total);
                document.getElementById('salvar-venda').disabled = appState.carrinho.length === 0 || !appState.pagamento;
            }
            
            function alterarQuantidade(produtoId, delta) {
                const item = appState.carrinho.find(item => item.Produto_ID === produtoId);
                if (item) {
                    item.Quantidade += delta;
                    if (item.Quantidade <= 0) {
                        appState.carrinho = appState.carrinho.filter(i => i.Produto_ID !== produtoId);
                    }
                }
                renderCarrinho();
            }

            function setupPagamentoButtons() {
                const pagamentoBtns = document.querySelectorAll('.pagamento-btn');
                pagamentoBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        appState.pagamento = btn.dataset.pagamento;
                        pagamentoBtns.forEach(b => b.classList.remove('bg-orange-500', 'text-white'));
                        btn.classList.add('bg-orange-500', 'text-white');
                        renderCarrinho();
                    });
                });
            }

            document.getElementById('salvar-venda').addEventListener('click', async () => {
                // A funcionalidade de salvar venda precisaria de uma nova função Netlify
                // para escrever na planilha. Por agora, esta funcionalidade está desativada.
                alert("A funcionalidade de salvar vendas ainda não foi implementada com a nova arquitetura.");
            });

            function renderProdutos() {
                const status = appState.activeProductStatusTab;
                const listaProdutosEl = document.getElementById('lista-produtos-catalogo');
                listaProdutosEl.innerHTML = '';
                DB.produtos.filter(p => p.Status === status).forEach(produto => {
                    const imagem = DB.imagens.find(i => i.Imagem_ID === produto.Imagem_Ref);
                    const categoria = DB.categorias.find(c => c.Categoria_ID === produto.Categoria_Ref);
                    const produtoCard = document.createElement('div');
                    produtoCard.className = 'bg-white rounded-xl shadow-md overflow-hidden flex flex-col';
                    produtoCard.innerHTML = `
                        <img src="${imagem ? imagem.Arquivo : 'https://placehold.co/400x300/cccccc/FFFFFF?text=Sem+Imagem'}" alt="${produto.Nome}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/FFFFFF?text=Erro';">
                        <div class="p-4 flex flex-col flex-grow">
                            <p class="text-xs text-orange-600 font-semibold">${categoria ? categoria.NomeCategoria.toUpperCase() : 'SEM CATEGORIA'}</p>
                            <h3 class="text-lg font-bold">${produto.Nome}</h3>
                            <p class="text-stone-600 mb-2 h-10 overflow-hidden flex-grow">${produto.Descricao}</p>
                            <p class="text-xl font-bold text-right mt-2">${formatCurrency(produto.Preco)}</p>
                        </div>
                        <div class="bg-stone-50 p-2 flex justify-end gap-2">
                            <button data-id="${produto.Produto_ID}" class="edit-product-btn p-2 rounded-full hover:bg-stone-200" title="Editar Produto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-stone-600" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button data-id="${produto.Produto_ID}" class="delete-product-btn p-2 rounded-full hover:bg-stone-200" title="Excluir/Inativar Produto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                    listaProdutosEl.appendChild(produtoCard);
                });

                document.querySelectorAll('.edit-product-btn').forEach(btn => btn.addEventListener('click', (e) => openProductModal(e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-product-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteProduct(e.currentTarget.dataset.id)));
            }

            document.querySelectorAll('.status-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    appState.activeProductStatusTab = btn.dataset.status;
                    document.querySelectorAll('.status-tab-btn').forEach(b => {
                        b.classList.remove('active', 'border-orange-500');
                        b.classList.add('text-stone-500', 'border-transparent');
                    });
                    btn.classList.add('active', 'border-orange-500');
                    btn.classList.remove('text-stone-500', 'border-transparent');
                    renderProdutos();
                });
            });
            
            document.getElementById('add-new-product-btn').addEventListener('click', () => openProductModal());

            function openProductModal(productId = null) {
                // Funcionalidade de edição/criação está desativada por agora
                alert("A funcionalidade de editar/criar produtos ainda não foi implementada com a nova arquitetura.");
            }
            
            function closeProductModal() {
                document.getElementById('product-modal').classList.add('hidden');
            }

            document.getElementById('cancel-product-modal').addEventListener('click', closeProductModal);
            
            async function handleDeleteProduct(productId) {
                 alert("A funcionalidade de apagar produtos ainda não foi implementada com a nova arquitetura.");
            }
            
            async function deleteSale(saleId) {
                alert("A funcionalidade de apagar vendas ainda não foi implementada com a nova arquitetura.");
            }
            
            function renderHistorico() {
                const container = document.getElementById('historico-lista-container');
                container.innerHTML = '';
                if (!DB.vendas || DB.vendas.length === 0) {
                    container.innerHTML = '<p class="text-stone-500">Nenhum histórico de vendas encontrado.</p>';
                    return;
                }

                const mesesNomes = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

                const dadosAgrupados = DB.vendas.reduce((acc, venda) => {
                    if (!venda.Data) return acc;
                    const data = new Date(venda.Data);
                    if (isNaN(data.getTime())) return acc;

                    const ano = data.getFullYear();
                    const mes = data.getMonth();
                    const semanaDoMes = Math.ceil(data.getDate() / 7);

                    if (!acc[ano]) acc[ano] = { total: 0, meses: {} };
                    if (!acc[ano].meses[mes]) acc[ano].meses[mes] = { total: 0, semanas: {} };
                    if (!acc[ano].meses[mes].semanas[semanaDoMes]) acc[ano].meses[mes].semanas[semanaDoMes] = { total: 0, vendas: [] };
                    
                    const totalVenda = parseFloat(venda.TotalVenda || 0);
                    acc[ano].total += totalVenda;
                    acc[ano].meses[mes].total += totalVenda;
                    acc[ano].meses[mes].semanas[semanaDoMes].total += totalVenda;
                    acc[ano].meses[mes].semanas[semanaDoMes].vendas.push(venda);
                    
                    return acc;
                }, {});

                const anosOrdenados = Object.keys(dadosAgrupados).sort((a, b) => b - a);

                if (anosOrdenados.length === 0) {
                    container.innerHTML = '<p class="text-stone-500">Nenhum histórico de vendas encontrado.</p>';
                    return;
                }

                anosOrdenados.forEach(ano => {
                    const anoData = dadosAgrupados[ano];
                    const anoEl = document.createElement('div');
                    anoEl.className = 'border-b border-stone-200 pb-2';
                    anoEl.innerHTML = `
                        <div class="accordion-header flex justify-between items-center cursor-pointer p-2 hover:bg-stone-100 rounded-md">
                            <div class="flex items-center gap-3">
                                <span class="accordion-header-icon font-bold text-lg text-orange-600">▶</span>
                                <span class="font-bold text-xl">${ano}</span>
                            </div>
                            <span class="font-bold text-xl text-stone-700">${formatCurrency(anoData.total)}</span>
                        </div>
                        <div class="accordion-content pl-6"></div>
                    `;
                    container.appendChild(anoEl);

                    const mesesContainer = anoEl.querySelector('.accordion-content');
                    const mesesOrdenados = Object.keys(anoData.meses).sort((a, b) => a - b);
                    
                    mesesOrdenados.forEach(mesIdx => {
                        const mesData = anoData.meses[mesIdx];
                        const mesEl = document.createElement('div');
                        mesEl.className = 'mt-2';
                        mesEl.innerHTML = `
                            <div class="accordion-header flex justify-between items-center cursor-pointer p-2 hover:bg-stone-100 rounded-md">
                                <div class="flex items-center gap-3">
                                    <span class="accordion-header-icon font-semibold text-stone-600">▶</span>
                                    <span class="font-semibold text-lg">${mesesNomes[mesIdx]}</span>
                                </div>
                                <span class="font-semibold text-lg text-stone-600">${formatCurrency(mesData.total)}</span>
                            </div>
                            <div class="accordion-content pl-6"></div>
                        `;
                        mesesContainer.appendChild(mesEl);

                        const semanasContainer = mesEl.querySelector('.accordion-content');
                        const semanasOrdenadas = Object.keys(mesData.semanas).sort((a, b) => a - b);

                        semanasOrdenadas.forEach(semanaNum => {
                            const semanaData = mesData.semanas[semanaNum];
                            const semanaEl = document.createElement('div');
                            semanaEl.className = 'mt-2';
                            semanaEl.innerHTML = `
                                <div class="accordion-header flex justify-between items-center cursor-pointer p-2 hover:bg-stone-100 rounded-md">
                                    <div class="flex items-center gap-3">
                                        <span class="accordion-header-icon text-stone-500">▶</span>
                                        <span class="text-md">Semana ${semanaNum}</span>
                                    </div>
                                    <span class="text-md font-semibold text-stone-500">${formatCurrency(semanaData.total)}</span>
                                </div>
                                <div class="accordion-content pl-8 pt-2 space-y-2"></div>
                            `;
                            semanasContainer.appendChild(semanaEl);

                            const vendasContainer = semanaEl.querySelector('.accordion-content');
                            semanaData.vendas.sort((a,b) => new Date(b.Data) - new Date(a.Data)).forEach(venda => {
                                const vendaEl = document.createElement('div');
                                vendaEl.className = 'flex justify-between items-center p-2 bg-stone-50 rounded-lg';
                                vendaEl.innerHTML = `
                                    <div class="flex-grow">
                                        <p class="font-semibold">${venda.NomeComprador || 'Cliente'} - ${new Date(venda.Data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p>
                                        <p class="text-sm text-stone-500">${venda.FormaPagamento}</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <p class="font-bold mr-4">${formatCurrency(venda.TotalVenda)}</p>
                                        <button data-id="${venda.Venda_ID}" class="delete-sale-btn p-2 rounded-full hover:bg-stone-200" title="Excluir Venda">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                        </button>
                                    </div>
                                `;
                                vendasContainer.appendChild(vendaEl);
                            });
                        });
                    });
                });

                document.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        header.parentElement.classList.toggle('open');
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    });
                });
                
                document.querySelectorAll('.delete-sale-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteSale(e.currentTarget.dataset.id);
                }));
            }

            fetchData();
        });
    </script>
</body>
</html>

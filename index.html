<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Cantina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilo para o botão ativo na barra lateral */
        .sidebar-btn.active {
            background-color: #ea580c; /* orange-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-item.open > .accordion-content {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ea580c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div class="flex h-screen bg-stone-100">
        <!-- Barra Lateral de Navegação -->
        <aside class="w-64 bg-white shadow-md flex flex-col">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-orange-600">Cantina</h1>
                <p class="text-sm text-stone-500">Painel de Controle</p>
            </div>
            <nav class="flex-1 px-4 space-y-2">
                <button onclick="showTab('painel-diario')" class="sidebar-btn w-full flex items-center py-3 px-4 rounded-lg text-stone-700 hover:bg-orange-500 hover:text-white transition-colors">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    Painel Diário
                </button>
                <button onclick="showTab('registrar-venda')" class="sidebar-btn w-full flex items-center py-3 px-4 rounded-lg text-stone-700 hover:bg-orange-500 hover:text-white transition-colors">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Registrar Venda
                </button>
                <button onclick="showTab('produtos')" class="sidebar-btn w-full flex items-center py-3 px-4 rounded-lg text-stone-700 hover:bg-orange-500 hover:text-white transition-colors">
                     <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z"></path></svg>
                    Produtos
                </button>
                <button onclick="showTab('historico')" class="sidebar-btn w-full flex items-center py-3 px-4 rounded-lg text-stone-700 hover:bg-orange-500 hover:text-white transition-colors">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Histórico
                </button>
            </nav>
        </aside>

        <!-- Área de Conteúdo Principal -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-stone-100 p-4 md:p-6 lg:p-8">
                <!-- Conteúdo das Abas -->
                <!-- Aba: Painel Diário -->
                <div id="painel-diario" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                            <h3 class="text-sm font-medium text-stone-500">Vendas (Hoje)</h3>
                            <p id="metric-vendas-hoje" class="mt-1 text-3xl font-semibold text-orange-600">--</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                            <h3 class="text-sm font-medium text-stone-500">Receita (Hoje)</h3>
                            <p id="metric-receita-hoje" class="mt-1 text-3xl font-semibold text-orange-600">R$ --</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                            <h3 class="text-sm font-medium text-stone-500">Ticket Médio (Hoje)</h3>
                            <p id="metric-ticket-medio" class="mt-1 text-3xl font-semibold text-orange-600">R$ --</p>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                            <h3 class="text-sm font-medium text-stone-500">Produto Mais Vendido (Hoje)</h3>
                            <p id="metric-produto-top" class="mt-1 text-2xl font-semibold text-orange-600">--</p>
                        </div>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                        <h3 class="text-lg font-medium text-stone-800">Últimas 5 Vendas</h3>
                        <div id="ultimas-vendas-container" class="mt-4 space-y-3">
                            <p class="text-stone-500">Carregando vendas...</p>
                        </div>
                    </div>
                </div>

                <!-- Aba: Registrar Venda -->
                <div id="registrar-venda" class="tab-content hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                                <h3 class="text-lg font-medium text-stone-800">Selecione os Produtos</h3>
                                <div class="my-4">
                                    <input type="text" id="search-product-input" placeholder="Buscar produto por nome..." class="w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                </div>
                                <div id="product-list-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4 max-h-[60vh] overflow-y-auto p-2"></div>
                            </div>
                        </div>
                        <div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 sticky top-8">
                                <h3 class="text-lg font-medium text-stone-800">Carrinho</h3>
                                <div class="mt-4 space-y-3" id="cart-items-container">
                                    <p class="text-stone-500">O carrinho está vazio.</p>
                                </div>
                                <div class="mt-6 border-t pt-4">
                                    <div class="flex justify-between items-center text-xl font-bold">
                                        <span>Total:</span>
                                        <span id="cart-total">R$ 0,00</span>
                                    </div>
                                    <div class="mt-4 flex">
                                        <div class="w-1/2 pr-2">
                                            <label for="metodo-pagamento" class="block text-sm font-medium text-stone-700">Pagamento</label>
                                            <select id="metodo-pagamento" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                                <option>PIX</option>
                                                <option>Cartão</option>
                                                <option>Dinheiro</option>
                                            </select>
                                        </div>
                                        <div class="w-1/2 pl-2">
                                            <label for="turno-venda" class="block text-sm font-medium text-stone-700">Turno</label>
                                            <select id="turno-venda" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                                <option>Manhã</option>
                                                <option>Noite</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button id="finalize-sale-btn" class="mt-6 w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 disabled:bg-orange-300 transition-colors">
                                        Finalizar Venda
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba: Produtos -->
                <div id="produtos" class="tab-content hidden">
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-stone-800">Gerenciar Produtos</h2>
                            <button id="add-product-btn" class="bg-orange-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-orange-700 transition-colors">Adicionar Produto</button>
                        </div>
                        <div id="product-management-container"></div>
                    </div>
                </div>

                <!-- Aba: Histórico -->
                <div id="historico" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                        <h2 class="text-xl font-bold text-stone-800 mb-4">Histórico de Vendas</h2>
                        <div id="sales-history-container" class="space-y-2"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modais (ficam fora da estrutura principal) -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Adicionar Novo Produto</h2>
            <form id="product-form">
                <input type="hidden" id="produto-id">
                <div class="space-y-4">
                    <div>
                        <label for="produto-nome" class="block text-sm font-medium text-stone-700">Nome do Produto</label>
                        <input type="text" id="produto-nome" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    </div>
                    <div>
                        <label for="produto-categoria" class="block text-sm font-medium text-stone-700">Categoria</label>
                        <select id="produto-categoria" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"></select>
                    </div>
                    <div>
                        <label for="produto-preco" class="block text-sm font-medium text-stone-700">Preço (R$)</label>
                        <input type="number" id="produto-preco" step="0.01" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    </div>
                    <div>
                        <label for="produto-imagem" class="block text-sm font-medium text-stone-700">URL da Imagem</label>
                        <input type="text" id="produto-imagem" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="cancel-product-btn" class="bg-stone-200 text-stone-800 py-2 px-4 rounded-lg hover:bg-stone-300">Cancelar</button>
                    <button type="submit" class="bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700">Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="sale-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 id="sale-modal-title" class="text-2xl font-bold mb-6">Editar Venda</h2>
            <form id="sale-form">
                <input type="hidden" id="sale-id">
                <div class="space-y-4">
                    <div>
                        <label for="sale-metodo-pagamento" class="block text-sm font-medium text-stone-700">Método de Pagamento</label>
                        <select id="sale-metodo-pagamento" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                            <option>PIX</option>
                            <option>Cartão</option>
                            <option>Dinheiro</option>
                        </select>
                    </div>
                    <div>
                        <label for="sale-turno" class="block text-sm font-medium text-stone-700">Turno</label>
                        <select id="sale-turno" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                            <option>Manhã</option>
                            <option>Noite</option>
                        </select>
                    </div>
                    <div class="border-t pt-4">
                        <h3 class="text-sm font-medium text-stone-700">Itens da Venda</h3>
                        <div id="sale-items-details" class="mt-2 text-sm text-stone-600 space-y-1"></div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="cancel-sale-btn" class="bg-stone-200 text-stone-800 py-2 px-4 rounded-lg hover:bg-stone-300">Cancelar</button>
                    <button type="submit" class="bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 id="confirmation-title" class="text-lg font-bold mb-4">Confirmar Ação</h2>
            <p id="confirmation-message" class="text-stone-600 mb-6">Você tem certeza?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-confirmation-btn" class="bg-stone-200 text-stone-800 py-2 px-4 rounded-lg hover:bg-stone-300">Cancelar</button>
                <button id="confirm-action-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 ease-out z-50">
        <p id="toast-message"></p>
    </div>

    <script>
        // =================================================================
        // CONFIGURAÇÃO
        // =================================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwbIwC1bknwcLSwdaICiZslepAG8CAj3NyBNlK2EsepZQVETPRSh7qUpWseHs7yZyAt/exec";

        // =================================================================
        // ESTADO DA APLICAÇÃO
        // =================================================================
        let allProducts = [];
        let allCategories = [];
        let allSales = [];
        let allSaleItems = [];
        let cart = [];

        // =================================================================
        // FUNÇÕES DE INICIALIZAÇÃO E CARREGAMENTO DE DADOS
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            showTab('painel-diario');
            fetchAllData();
            setupEventListeners();
        });

        async function fetchAllData() {
            try {
                showGlobalLoader(true);
                const [products, categories, sales, saleItems] = await Promise.all([
                    fetchData('produtos'),
                    fetchData('categorias'),
                    fetchData('vendas'),
                    fetchData('itens_venda')
                ]);
                
                allProducts = products;
                allCategories = categories;
                allSales = sales;
                allSaleItems = saleItems;

                updateDashboard();
                populateProductsForSale();
                populateCategoryFilter();
                
            } catch (error) {
                console.error("Erro ao carregar dados iniciais:", error);
                showToast("Falha ao carregar dados. Verifique a conexão e as configurações do script.", "error");
            } finally {
                showGlobalLoader(false);
            }
        }

        async function fetchData(sheetName) {
            try {
                const response = await fetch(`${SCRIPT_URL}?sheet=${sheetName}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if(data.status === 'error') throw new Error(`API Error: ${data.message}`);
                return data;
            } catch (error) {
                console.error(`Erro ao buscar dados da aba '${sheetName}':`, error);
                throw error;
            }
        }
        
        // =================================================================
        // LÓGICA DAS ABAS E UI
        // =================================================================
        function showTab(tabName) {
            // Esconde todos os conteúdos
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            // Desativa todos os botões da barra lateral
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            
            // Mostra o conteúdo da aba selecionada
            document.getElementById(tabName).classList.remove('hidden');
            // Ativa o botão da aba selecionada
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');

            // Ações específicas para cada aba
            if (tabName === 'painel-diario') updateDashboard();
            if (tabName === 'produtos') loadProductsForManagement();
            if (tabName === 'historico') loadSalesHistory();
            if (tabName === 'registrar-venda') {
                const turnoSelect = document.getElementById('turno-venda');
                const currentHour = new Date().getHours();
                turnoSelect.value = currentHour < 14 ? 'Manhã' : 'Noite';
            }
        }
        
        function setupEventListeners() {
            document.getElementById('search-product-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = allProducts.filter(p => p.Status === 'Ativo' && p.Nome_Produto.toLowerCase().includes(searchTerm));
                populateProductsForSale(filtered);
            });
            
            document.getElementById('finalize-sale-btn').addEventListener('click', handleFinalizeSale);
            
            document.getElementById('add-product-btn').addEventListener('click', () => showProductModal());
            document.getElementById('cancel-product-btn').addEventListener('click', hideProductModal);
            document.getElementById('product-form').addEventListener('submit', handleProductFormSubmit);
            
            document.getElementById('cancel-sale-btn').addEventListener('click', hideSaleModal);
            document.getElementById('sale-form').addEventListener('submit', handleSaleFormSubmit);

            document.getElementById('cancel-confirmation-btn').addEventListener('click', hideConfirmationModal);
        }

        // =================================================================
        // PAINEL DIÁRIO
        // =================================================================
        function updateDashboard() {
            const todayStr = new Date().toISOString().slice(0, 10);
            const salesToday = allSales.filter(s => s.Data_Venda && s.Data_Venda.startsWith(todayStr));
            const saleItemsToday = allSaleItems.filter(item => salesToday.some(s => s.Venda_ID === item.Venda_Ref));

            const totalSalesToday = salesToday.length;
            const totalRevenueToday = salesToday.reduce((sum, sale) => sum + parseFloat(sale.Valor_Total || 0), 0);
            const averageTicket = totalSalesToday > 0 ? (totalRevenueToday / totalSalesToday) : 0;

            document.getElementById('metric-vendas-hoje').textContent = totalSalesToday;
            document.getElementById('metric-receita-hoje').textContent = `R$ ${totalRevenueToday.toFixed(2).replace('.', ',')}`;
            document.getElementById('metric-ticket-medio').textContent = `R$ ${averageTicket.toFixed(2).replace('.', ',')}`;

            let topProduct = '--';
            if (saleItemsToday.length > 0) {
                const productCounts = saleItemsToday.reduce((acc, item) => {
                    acc[item.Produto_Nome] = (acc[item.Produto_Nome] || 0) + parseInt(item.Quantidade, 10);
                    return acc;
                }, {});
                if (Object.keys(productCounts).length > 0) {
                   topProduct = Object.keys(productCounts).reduce((a, b) => productCounts[a] > productCounts[b] ? a : b);
                }
            }
            document.getElementById('metric-produto-top').textContent = topProduct;
            
            const last5Sales = salesToday.slice(-5).reverse();
            const container = document.getElementById('ultimas-vendas-container');
            container.innerHTML = '';
            if (last5Sales.length === 0) {
                container.innerHTML = '<p class="text-stone-500">Nenhuma venda registrada hoje.</p>';
                return;
            }
            last5Sales.forEach(sale => {
                const saleEl = document.createElement('div');
                saleEl.className = 'flex justify-between items-center bg-stone-50 p-3 rounded-lg';
                saleEl.innerHTML = `
                    <div>
                        <p class="font-medium">Venda #${sale.Venda_ID}</p>
                        <p class="text-sm text-stone-500">${new Date(sale.Data_Venda).toLocaleTimeString('pt-BR')} - ${sale.Metodo_Pagamento}</p>
                    </div>
                    <div class="font-semibold text-lg">R$ ${parseFloat(sale.Valor_Total).toFixed(2).replace('.', ',')}</div>
                `;
                container.appendChild(saleEl);
            });
        }
        
        // =================================================================
        // REGISTRAR VENDA (CARRINHO)
        // =================================================================
        function populateProductsForSale(products = null) {
            const container = document.getElementById('product-list-container');
            container.innerHTML = '';
            const activeProducts = products || allProducts.filter(p => p.Status === 'Ativo');
            if (activeProducts.length === 0) {
                container.innerHTML = '<p class="text-stone-500 col-span-full text-center">Nenhum produto encontrado.</p>';
                return;
            }
            activeProducts.forEach(p => {
                const el = document.createElement('div');
                el.className = 'bg-white border border-stone-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md hover:border-orange-400 transition-all';
                el.onclick = () => addToCart(p);
                el.innerHTML = `
                    <img src="${p.URL_Imagem || 'https://placehold.co/300x300/f97316/white?text=' + p.Nome_Produto.charAt(0)}" onerror="this.onerror=null;this.src='https://placehold.co/300x300/e7e5e4/57534e?text=Erro';" class="w-full h-24 object-cover rounded-md mb-2">
                    <h4 class="font-semibold text-sm truncate">${p.Nome_Produto}</h4>
                    <p class="text-stone-600">R$ ${parseFloat(p.Preco_Venda).toFixed(2).replace('.', ',')}</p>
                `;
                container.appendChild(el);
            });
        }

        function addToCart(product) {
            const existing = cart.find(item => item.Produto_ID === product.Produto_ID);
            if (existing) existing.Quantidade++;
            else cart.push({ ...product, Quantidade: 1 });
            updateCart();
        }

        function updateCart() {
            const container = document.getElementById('cart-items-container');
            const totalEl = document.getElementById('cart-total');
            const finalizeBtn = document.getElementById('finalize-sale-btn');
            container.innerHTML = '';

            if (cart.length === 0) {
                container.innerHTML = '<p class="text-stone-500">O carrinho está vazio.</p>';
                totalEl.textContent = 'R$ 0,00';
                finalizeBtn.disabled = true;
                return;
            }

            let total = 0;
            cart.forEach(item => {
                total += item.Preco_Venda * item.Quantidade;
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center justify-between text-sm';
                itemEl.innerHTML = `
                    <div>
                        <p class="font-medium">${item.Nome_Produto}</p>
                        <p class="text-stone-500">R$ ${parseFloat(item.Preco_Venda).toFixed(2).replace('.', ',')}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="changeQuantity('${item.Produto_ID}', -1)" class="w-6 h-6 bg-stone-200 rounded-full font-bold">-</button>
                        <span>${item.Quantidade}</span>
                        <button onclick="changeQuantity('${item.Produto_ID}', 1)" class="w-6 h-6 bg-stone-200 rounded-full font-bold">+</button>
                    </div>
                `;
                container.appendChild(itemEl);
            });

            totalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            finalizeBtn.disabled = false;
        }
        
        function changeQuantity(productId, amount) {
            const item = cart.find(i => i.Produto_ID === productId);
            if (item) {
                item.Quantidade += amount;
                if (item.Quantidade <= 0) cart = cart.filter(i => i.Produto_ID !== productId);
                updateCart();
            }
        }

        async function handleFinalizeSale() {
            if (cart.length === 0) return;
            showGlobalLoader(true);
            const nextSaleId = allSales.length > 0 ? Math.max(...allSales.map(s => parseInt(s.Venda_ID) || 0)) + 1 : 1;
            const total = cart.reduce((sum, item) => sum + item.Preco_Venda * item.Quantidade, 0);
            const novaVenda = {
                Venda_ID: nextSaleId,
                Data_Venda: new Date().toISOString(),
                Valor_Total: total,
                Metodo_Pagamento: document.getElementById('metodo-pagamento').value,
                Turno: document.getElementById('turno-venda').value
            };
            const itensCarrinho = cart.map(item => ({
                Item_ID: `${nextSaleId}-${item.Produto_ID}`, Venda_Ref: nextSaleId, Produto_Ref: item.Produto_ID,
                Produto_Nome: item.Nome_Produto, Quantidade: item.Quantidade, Preco_Unitario: item.Preco_Venda,
                Subtotal: item.Quantidade * item.Preco_Venda
            }));
            
            try {
                const res = await postData({ action: 'saveSale', payload: { novaVenda, itensCarrinho } });
                if (res.status !== 'success') throw new Error(res.message);
                showToast("Venda registrada com sucesso!", "success");
                cart = [];
                updateCart();
                await fetchAllData();
                showTab('painel-diario');
            } catch (error) {
                showToast(`Erro ao salvar: ${error.message}`, "error");
            } finally {
                showGlobalLoader(false);
            }
        }

        // =================================================================
        // GERENCIAMENTO DE PRODUTOS
        // =================================================================
        function loadProductsForManagement() {
            const container = document.getElementById('product-management-container');
            container.innerHTML = `
                <table class="min-w-full divide-y divide-stone-200">
                    <thead class="bg-stone-50"><tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase">Produto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase">Categoria</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase">Preço</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase">Ações</th>
                    </tr></thead>
                    <tbody class="bg-white divide-y divide-stone-200">
                        ${allProducts.map(p => `
                            <tr>
                                <td class="px-6 py-4"><div class="flex items-center">
                                    <div class="h-10 w-10 flex-shrink-0"><img class="h-10 w-10 rounded-full object-cover" src="${p.URL_Imagem || 'https://placehold.co/100x100/f97316/white?text=' + p.Nome_Produto.charAt(0)}" alt=""></div>
                                    <div class="ml-4"><div class="text-sm font-medium text-stone-900">${p.Nome_Produto}</div><div class="text-sm text-stone-500">ID: ${p.Produto_ID}</div></div>
                                </div></td>
                                <td class="px-6 py-4 text-sm text-stone-500">${p.Categoria}</td>
                                <td class="px-6 py-4 text-sm text-stone-500">R$ ${parseFloat(p.Preco_Venda).toFixed(2).replace('.', ',')}</td>
                                <td class="px-6 py-4"><span class="px-2 inline-flex text-xs font-semibold rounded-full ${p.Status === 'Ativo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${p.Status}</span></td>
                                <td class="px-6 py-4 text-right text-sm font-medium space-x-2">
                                    <button onclick="showProductModal('${p.Produto_ID}')" class="text-orange-600 hover:text-orange-900">Editar</button>
                                    ${p.Status === 'Ativo' ? `<button onclick="confirmInactivateProduct('${p.Produto_ID}')" class="text-yellow-600 hover:text-yellow-900">Inativar</button>` : `<button onclick="confirmDeleteProduct('${p.Produto_ID}')" class="text-red-600 hover:text-red-900">Excluir</button>`}
                                </td>
                            </tr>`).join('')}
                    </tbody>
                </table>`;
        }
        
        function showProductModal(productId = null) {
            const form = document.getElementById('product-form');
            form.reset();
            populateCategoryFilter();
            const modalTitle = document.getElementById('modal-title');
            if (productId) {
                const product = allProducts.find(p => p.Produto_ID == productId);
                modalTitle.textContent = "Editar Produto";
                document.getElementById('produto-id').value = product.Produto_ID;
                document.getElementById('produto-nome').value = product.Nome_Produto;
                document.getElementById('produto-categoria').value = product.Categoria;
                document.getElementById('produto-preco').value = product.Preco_Venda;
                document.getElementById('produto-imagem').value = product.URL_Imagem;
            } else {
                modalTitle.textContent = "Adicionar Novo Produto";
                document.getElementById('produto-id').value = '';
            }
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function hideProductModal() { document.getElementById('product-modal').classList.add('hidden'); }

        async function handleProductFormSubmit(e) {
            e.preventDefault();
            showGlobalLoader(true);
            const productId = document.getElementById('produto-id').value;
            const isEditing = !!productId;
            const nextId = allProducts.length > 0 ? Math.max(...allProducts.map(p => parseInt(p.Produto_ID) || 0)) + 1 : 1;
            const productData = {
                Produto_ID: isEditing ? productId : nextId, Nome_Produto: document.getElementById('produto-nome').value,
                Categoria: document.getElementById('produto-categoria').value, Preco_Venda: parseFloat(document.getElementById('produto-preco').value),
                URL_Imagem: document.getElementById('produto-imagem').value,
                Status: isEditing ? allProducts.find(p => p.Produto_ID == productId).Status : 'Ativo'
            };
            const action = isEditing ? 'updateProduct' : 'createProduct';
            try {
                const res = await postData({ action, payload: productData });
                if (res.status !== 'success') throw new Error(res.message);
                showToast(`Produto ${isEditing ? 'atualizado' : 'criado'} com sucesso!`, "success");
                hideProductModal();
                await fetchAllData();
                loadProductsForManagement();
            } catch (error) {
                showToast(`Erro: ${error.message}`, "error");
            } finally {
                showGlobalLoader(false);
            }
        }

        function confirmInactivateProduct(productId) {
            showConfirmationModal('Inativar Produto', 'Tem certeza que deseja inativar este produto?', async () => {
                showGlobalLoader(true);
                try {
                    const res = await postData({ action: 'inactivateProduct', payload: { Produto_ID: productId } });
                    if (res.status !== 'success') throw new Error(res.message);
                    showToast('Produto inativado com sucesso.', 'success');
                    await fetchAllData();
                    loadProductsForManagement();
                } catch (error) { showToast(`Erro: ${error.message}`, 'error'); } 
                finally { showGlobalLoader(false); }
            });
        }

        function confirmDeleteProduct(productId) {
            showConfirmationModal('Excluir Produto', 'Atenção! Esta ação é permanente. Deseja realmente excluir?', async () => {
                showGlobalLoader(true);
                try {
                    const res = await postData({ action: 'deleteProduct', payload: { Produto_ID: productId } });
                    if (res.status !== 'success') throw new Error(res.message);
                    showToast('Produto excluído permanentemente.', 'success');
                    await fetchAllData();
                    loadProductsForManagement();
                } catch (error) { showToast(`Erro: ${error.message}`, 'error'); } 
                finally { showGlobalLoader(false); }
            });
        }

        // =================================================================
        // HISTÓRICO DE VENDAS
        // =================================================================
        function loadSalesHistory() {
            const container = document.getElementById('sales-history-container');
            container.innerHTML = '';
            if (allSales.length === 0) {
                container.innerHTML = '<p class="text-stone-500">Nenhum histórico de vendas encontrado.</p>';
                return;
            }

            const salesByYear = groupBy(allSales, s => new Date(s.Data_Venda).getFullYear());
            const sortedYears = Object.keys(salesByYear).sort((a, b) => b - a);

            sortedYears.forEach(year => {
                const yearAccordion = createAccordionItem(year, 'bg-stone-200');
                container.appendChild(yearAccordion.item);
                
                const salesByMonth = groupBy(salesByYear[year], s => new Date(s.Data_Venda).getMonth());
                const sortedMonths = Object.keys(salesByMonth).sort((a, b) => b - a);

                sortedMonths.forEach(monthIndex => {
                    const monthName = new Date(year, monthIndex).toLocaleString('pt-BR', { month: 'long' });
                    const monthAccordion = createAccordionItem(monthName.charAt(0).toUpperCase() + monthName.slice(1), 'bg-stone-100');
                    yearAccordion.content.appendChild(monthAccordion.item);

                    const salesByDay = groupBy(salesByMonth[monthIndex], s => new Date(s.Data_Venda).getDate());
                    const sortedDays = Object.keys(salesByDay).sort((a, b) => b - a);

                    sortedDays.forEach(day => {
                        const date = new Date(year, monthIndex, day);
                        const dayAccordion = createAccordionItem(`${date.toLocaleDateString('pt-BR')} - ${date.toLocaleDateString('pt-BR', { weekday: 'long' })}`);
                        monthAccordion.content.appendChild(dayAccordion.item);
                        
                        const salesOfTheDay = salesByDay[day].sort((a, b) => new Date(b.Data_Venda) - new Date(a.Data_Venda));
                        
                        salesOfTheDay.forEach(sale => {
                            const saleItems = allSaleItems.filter(item => item.Venda_Ref == sale.Venda_ID);
                            const saleDetail = document.createElement('div');
                            saleDetail.className = 'p-4 border-t border-stone-200';
                            saleDetail.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h5 class="font-bold">Venda #${sale.Venda_ID} - ${new Date(sale.Data_Venda).toLocaleTimeString('pt-BR')}</h5>
                                        <p class="text-sm text-stone-500">Pagamento: ${sale.Metodo_Pagamento} | Turno: ${sale.Turno}</p>
                                        <ul class="list-disc pl-5 mt-2 text-sm">
                                            ${saleItems.map(item => `<li>${item.Quantidade}x ${item.Produto_Nome} (R$ ${parseFloat(item.Subtotal).toFixed(2).replace('.',',')})</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="text-right space-y-2">
                                        <p class="font-bold text-lg">R$ ${parseFloat(sale.Valor_Total).toFixed(2).replace('.',',')}</p>
                                        <div class="flex flex-col sm:flex-row gap-2 items-end">
                                            <button onclick="showSaleModal('${sale.Venda_ID}')" class="text-sm bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600">Editar</button>
                                            <button onclick="confirmDeleteSale('${sale.Venda_ID}')" class="text-sm bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-600">Excluir</button>
                                        </div>
                                    </div>
                                </div>`;
                            dayAccordion.content.appendChild(saleDetail);
                        });
                    });
                });
            });
        }

        function confirmDeleteSale(saleId) {
            showConfirmationModal('Excluir Venda', `Deseja realmente excluir a venda #${saleId} e seus itens?`, async () => {
                showGlobalLoader(true);
                try {
                    const res = await postData({ action: 'deleteSale', payload: { Venda_ID: saleId } });
                    if (res.status !== 'success') throw new Error(res.message);
                    showToast('Venda excluída com sucesso.', 'success');
                    await fetchAllData();
                    loadSalesHistory();
                } catch (error) {
                    showToast(`Erro ao excluir: ${error.message}`, 'error');
                } finally {
                    showGlobalLoader(false);
                }
            });
        }
        
        function showSaleModal(saleId) {
            const sale = allSales.find(s => s.Venda_ID == saleId);
            if (!sale) {
                showToast("Venda não encontrada.", "error");
                return;
            }
            
            document.getElementById('sale-id').value = sale.Venda_ID;
            document.getElementById('sale-modal-title').textContent = `Editar Venda #${sale.Venda_ID}`;
            document.getElementById('sale-metodo-pagamento').value = sale.Metodo_Pagamento;
            document.getElementById('sale-turno').value = sale.Turno;

            const itemsContainer = document.getElementById('sale-items-details');
            const saleItems = allSaleItems.filter(item => item.Venda_Ref == saleId);
            itemsContainer.innerHTML = saleItems.map(item => 
                `<p>${item.Quantidade}x ${item.Produto_Nome}</p>`
            ).join('');

            document.getElementById('sale-modal').classList.remove('hidden');
        }

        function hideSaleModal() {
            document.getElementById('sale-modal').classList.add('hidden');
        }

        async function handleSaleFormSubmit(e) {
            e.preventDefault();
            showGlobalLoader(true);
            
            const saleId = document.getElementById('sale-id').value;
            const updatedData = {
                Venda_ID: saleId,
                Metodo_Pagamento: document.getElementById('sale-metodo-pagamento').value,
                Turno: document.getElementById('sale-turno').value,
            };

            try {
                const res = await postData({ action: 'updateSale', payload: updatedData });
                if (res.status !== 'success') throw new Error(res.message);
                showToast('Venda atualizada com sucesso!', 'success');
                hideSaleModal();
                await fetchAllData();
                loadSalesHistory();
            } catch (error) {
                showToast(`Erro ao atualizar: ${error.message}`, "error");
            } finally {
                showGlobalLoader(false);
            }
        }

        // =================================================================
        // FUNÇÕES UTILITÁRIAS E COMPONENTES
        // =================================================================
        async function postData(data) {
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache', credentials: 'omit',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data), redirect: 'follow'
                });
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return await res.json();
            } catch (error) {
                console.error('Erro no POST:', error);
                throw error;
            }
        }

        function populateCategoryFilter() {
            const select = document.getElementById('produto-categoria');
            select.innerHTML = '<option value="">Selecione...</option>';
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.Nome_Categoria;
                option.textContent = cat.Nome_Categoria;
                select.appendChild(option);
            });
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = 'fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transform transition-all duration-300 ease-out z-50';
            if (type === 'success') toast.classList.add('bg-green-600');
            else if (type === 'error') toast.classList.add('bg-red-600');
            else toast.classList.add('bg-stone-800');
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 4000);
        }
        
        function showGlobalLoader(isLoading) {
            let loader = document.getElementById('global-loader');
            if (isLoading) {
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'global-loader';
                    loader.className = 'fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-[100]';
                    loader.innerHTML = '<div class="loader"></div>';
                    document.body.appendChild(loader);
                }
                loader.classList.remove('hidden');
            } else if (loader) {
                loader.classList.add('hidden');
            }
        }
        
        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            const confirmBtn = document.getElementById('confirm-action-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                hideConfirmationModal();
                onConfirm();
            });
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function hideConfirmationModal() { document.getElementById('confirmation-modal').classList.add('hidden'); }
        
        function groupBy(array, keyGetter) {
            return array.reduce((acc, item) => {
                const key = keyGetter(item);
                (acc[key] = acc[key] || []).push(item);
                return acc;
            }, {});
        }
        
        function createAccordionItem(title, headerBg = 'bg-white') {
            const item = document.createElement('div');
            item.className = 'accordion-item border border-stone-200 rounded-lg overflow-hidden';
            
            const header = document.createElement('div');
            header.className = `accordion-header flex justify-between items-center p-3 cursor-pointer hover:bg-stone-200/50 ${headerBg}`;
            header.innerHTML = `<h4 class="font-semibold">${title}</h4><svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
            
            const content = document.createElement('div');
            content.className = 'accordion-content bg-stone-50/50 pl-4';
            
            item.appendChild(header);
            item.appendChild(content);
            
            header.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = item.classList.contains('open');
                item.classList.toggle('open');
                header.querySelector('svg').classList.toggle('rotate-180', !isOpen);
            });
            
            return { item, content };
        }

    </script>
</body>
</html>
